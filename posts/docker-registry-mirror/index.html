<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta http-equiv=content-security-policy content="default-src 'none'; style-src 'self' 'unsafe-inline'; img-src 'self' https:; font-src 'self'; script-src 'unsafe-inline'"><link rel="shortcut icon" type=image/png href=/favicon.png><link rel=sitemap type=application/xml href=/sitemap.xml title=knrdlog><title>Docker Registry Mirror</title><meta name=description content="notes to self"><meta property="og:title" content="Docker Registry Mirror"><meta property="og:description" content="Concept A docker-registry stores docker-images, composed of:
metadata: image names and tags blobs: actual image contents The most famous public docker-registry is DockerHub. DockerHub applies a rate-limiting for downloading blobs. The fetching of metadata is not sanctioned. Therefore, a local docker-registry mirror can be used to circumvent DockerHub&rsquo;s rate-limiting. This might also reduce the bandwidth usage of your ISP connection.
For metadata retrieval the docker-registry mirror will serve as a simple proxy server to the upstream (e."><meta property="og:type" content="article"><meta property="og:url" content="https://knrdl.github.io/posts/docker-registry-mirror/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-21T00:00:00+00:00"><meta property="article:modified_time" content="2022-09-21T16:01:00+02:00"><meta name=author content="knrdl"><link rel=stylesheet href=https://knrdl.github.io/styles.min.8077fb0b7b4110966f3cd3856ad5fc84d33a69bc800688b7a5f5c01036b68a53.css integrity="sha256-gHf7C3tBEJZvPNOFatX8hNM6abyABoi3pfXAEDa2ilM="></head><body><header><div class=site-header><span><a href=https://knrdl.github.io/ class=site-title>knrdlog</a></span>
<span><nav class=right-menu><span class=menu-item><a href=/tags/>tags</a></span>
<span class=menu-item><a href=https://github.com/knrdl target=_blank rel="noopener noreferrer">github</a></span>
<span class=menu-item><a href=/index.xml>rss</a></span></nav></span></div><div class=separator>================================================================================================================================================================</div></header><main><article><div class=post-header><h1>Docker Registry Mirror</h1><time datetime=2022-09-21 class=pubdate>2022-09-21</time>
<span class=tags><a href=/tags/docker class=hashtag>docker</a>
<a href=/tags/kaniko class=hashtag>kaniko</a>
<a href=/tags/podman class=hashtag>podman</a></span></div><h2 id=concept class=paragraph-header>Concept <a href=#concept></a></h2><p>A docker-registry stores docker-images, composed of:</p><ul><li><strong>metadata</strong>: image names and tags</li><li><strong>blobs</strong>: actual image contents</li></ul><p>The most famous public docker-registry is
<a href=https://hub.docker.com target=_blank rel="noopener noreferrer">DockerHub</a>. DockerHub applies a rate-limiting for downloading blobs. The fetching of metadata is not sanctioned. Therefore, a local docker-registry mirror can be used to circumvent DockerHub&rsquo;s rate-limiting. This might also reduce the bandwidth usage of your ISP connection.</p><p>For metadata retrieval the docker-registry mirror will serve as a simple proxy server to the upstream (e.g. DockerHub). If you retrieve a docker-image via the mirror the blobs are stored locally by the mirror. That way the mirror can serve as a cache for further requests. For example, when multiple servers deploy the same docker-image, only the first request will be a cache-miss. As the metadata records are always fetched from upstream, there is no risk of serving outdated docker-images.</p><h2 id=setup class=paragraph-header>Setup <a href=#setup></a></h2><h3 id=server class=paragraph-header>Server <a href=#server></a></h3><p>The registry mirror is a simple docker container:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>version</span>: <span style=color:#f1fa8c>&#39;3.9&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>registry-mirror</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>image</span>: registry:2
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>hostname</span>: registry-mirror
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>environment</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>REGISTRY_PROXY_REMOTEURL</span>: https://registry-1.docker.io  <span style=color:#6272a4># Mirror DockerHub</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>networks</span>:
</span></span><span style=display:flex><span>      - reverse_proxy_net  <span style=color:#6272a4># just an example</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>deploy</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>resources</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>reservations</span>:
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>memory</span>: 16m
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>limits</span>:
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>memory</span>: 250m
</span></span></code></pre></div><p>It should always be exposed via HTTPS to the clients, by a tls-terminating reverse-proxy. The registry-mirror runs http on port 5000.</p><p>Cached images can be listed via <code>curl https://registry-mirror.example.org/v2/_catalog</code>.</p><h3 id=clients class=paragraph-header>Clients <a href=#clients></a></h3><h4 id=docker class=paragraph-header>Docker <a href=#docker></a></h4><blockquote><p class=warning>On the server which should execute the registry-mirror run <code>docker pull registry:2</code> first, to prevent the chicken or egg problem.</p></blockquote><p>To make Docker use the registry mirror, add to <code>/etc/docker/daemon.json</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>&#34;registry-mirrors&#34;</span>: [
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;https://registry-mirror.example.org&#34;</span>
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Then restart the docker daemon: <code>sudo systemctl restart docker.service</code></p><h4 id=podman class=paragraph-header>Podman <a href=#podman></a></h4><p>Add to <code>$HOME/.config/containers/registries.conf</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#ff79c6>[[registry.mirror]]</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>location</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;registry-mirror.example.org&#34;</span>
</span></span></code></pre></div><h4 id=kaniko class=paragraph-header>Kaniko <a href=#kaniko></a></h4><p>To make Kaniko use the mirror, run it with the flag:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>/kaniko/executor --registry-mirror<span style=color:#ff79c6>=</span>registry-mirror.example.org ...
</span></span></code></pre></div><h2 id=operations class=paragraph-header>Operations <a href=#operations></a></h2><p>The registry mirror might be part of the critical path for high availability. Make sure all hosts are provided with their docker-images before shutting it down for maintenance etc.</p><p>There is no authentication in place, anybody with access can download arbitrary images. Therefore, the registry mirror should only be exposed to the server&rsquo;s network segment.</p><p>There is no storage limit per default and old blobs will not be pruned automatically. An attacker might crash the server by querying too many images. As countermeasure a storage quota should be applied. Also restarting the mirror container from time to time (e.g. patch-day server reboots) helps to reduce the storage usage.</p><div class=comments><a href="https://github.com/knrdl/knrdl.github.io/issues/new?title=Docker+Registry+Mirror" target=_blank rel="noopener noreferrer"><img src=https://knrdl.github.io/github.png alt="Github logo" style=filter:invert(.7) width=17 height=17>
<span>Feedback</span></a></div></article></main><hr><footer>Licensed under <a href=https://creativecommons.org/publicdomain/zero/1.0/ target=_blank rel='noopener norefferer'>CC0 1.0</a> |
<a href=https://gohugo.io target=_blank rel='noopener norefferer'>Hugo</a> theme inspired by <a href=https://github.com/vamc19 target=_blank rel='noopener norefferer'>vamc19</a> |
Hosted by <a href=https://pages.github.com target=_blank rel='noopener norefferer'>Github</a> (<a href=https://github.com/site/privacy target=_blank rel='noopener norefferer'>Privacy Policy</a>)</footer></body></html>