<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta http-equiv=content-security-policy content="default-src 'none'; style-src 'self' 'unsafe-inline'; img-src 'self' https:; font-src 'self'; script-src 'unsafe-inline'"><link rel="shortcut icon" type=image/png href=/favicon.png><link rel=sitemap type=application/xml href=/sitemap.xml title=knrdlog><title>How to stop your Raspberry Pi from eating SD Cards</title><meta name=description content="notes to self"><meta property="og:title" content="How to stop your Raspberry Pi from eating SD Cards"><meta property="og:description" content="Problem SD (or MicroSD) Cards are cheap flash storage. Their lifetime is limited by the performable write operations. If their end of life is reached, they don&rsquo;t work at all or read data unreliably.
A Raspberry Pi produces more IO operations than a typical digital camera (which SD Cards are conceptualized for). The load is mostly produced by writing:
Temporary files in /tmp/ Variable files in /var/ The swap file in /var/swap Files in other application and user specific directories It also depends on the usage of the Pi: e."><meta property="og:type" content="article"><meta property="og:url" content="https://knrdl.github.io/posts/raspberrypi-eating-sd-cards/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-03T00:00:00+00:00"><meta property="article:modified_time" content="2022-10-03T21:24:39+02:00"><meta name=author content="knrdl"><link rel=stylesheet href=https://knrdl.github.io/styles.min.e12cde4fe427445585f700d8463ce5ad7916721aee44e174dc3d324d2f5ca89e.css integrity="sha256-4SzeT+QnRFWF9wDYRjzlrXkWchruROF03D0yTS9cqJ4="></head><body><header><div class=site-header><span><a href=https://knrdl.github.io/ class=site-title>knrdlog</a></span>
<span><nav class=right-menu><span class=menu-item><a href=/tags/>tags</a></span>
<span class=menu-item><a href=https://github.com/knrdl target=_blank rel="noopener noreferrer">github</a></span>
<span class=menu-item><a href=/index.xml>rss</a></span></nav></span></div><div class=separator>================================================================================================================================================================</div></header><main><article><div class=post-header><h1>How to stop your Raspberry Pi from eating SD Cards</h1><time datetime=2022-10-03 class=pubdate>2022-10-03</time>
<span class=tags><a href=/tags/linux class=hashtag>linux</a>
<a href=/tags/raspberrypi class=hashtag>raspberrypi</a></span></div><h2 id=problem class=paragraph-header>Problem <a href=#problem></a></h2><p>SD (or MicroSD) Cards are cheap flash storage. Their lifetime is limited by the performable write operations. If their end of life is reached, they don&rsquo;t work at all or read data unreliably.</p><p>A Raspberry Pi produces more IO operations than a typical digital camera (which SD Cards are conceptualized for). The load is mostly produced by writing:</p><ul><li>Temporary files in <code>/tmp/</code></li><li>Variable files in <code>/var/</code></li><li>The swap file in <code>/var/swap</code></li><li>Files in other application and user specific directories</li></ul><p>It also depends on the usage of the Pi: e.g. compiling a big pile of software on the Pi is never a good idea in terms of SD Card lifetime.</p><p>It&rsquo;s possible to run a Pi only with a SD Card for a long time. One of my Pi&rsquo;s now runs successfully for more than 5 years that way. However, you can&rsquo;t tell it beforehand.</p><h2 id=solution class=paragraph-header>Solution <a href=#solution></a></h2><p>So the solution is to reduce the IO operations performed against the SD Card. A simple attempt is to disable swapping: <code>sudo systemctl disable --now dphys-swapfile</code>. A better alternative is moving write intense directories to an external drive. There are two options:</p><ul><li><strong>Option A</strong>: The Raspberry boots directly from a USB drive (e.g. USB thumb drive, SSD or HDD). No SD Card required.</li><li><strong>Option B</strong>: The Raspberry boots from the SD Card and mounts an external USB drive where the heavy disk IO is performed later on.</li></ul><h3 id=option-a---fresh-installation class=paragraph-header>Option A - Fresh installation <a href=#option-a---fresh-installation></a></h3><p>This option is pretty easy to realize, just flash the OS image (e.g. Raspberry Pi OS, formerly known as Raspbian) to the USB drive. However, it might not work with all kinds of USB drives. Also, a cheap USB thumb drive might have the same problems as a SD Card. Therefore, a durable SSD should be used instead. An old HDD is also a valid alternative. But your Pi might crash if spinning up the HDD consumes more power than can be supplied.</p><h3 id=option-b---external-disk class=paragraph-header>Option B - External disk <a href=#option-b---external-disk></a></h3><p>This is useful if your Pi is already set up and running. The separation will split the filestorage into static files (stored on the SD Card) and dynamic files (stored on the USB drive).</p><p>You need to copy the dynamic files to the external drive. But first you should stop all running applications to prevent inconsistency when copying files.</p><p>Disable the swap:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo swapoff -a  <span style=color:#6272a4># disable the swap</span>
</span></span><span style=display:flex><span>cat /proc/swaps  <span style=color:#6272a4># check that no swap is active</span>
</span></span></code></pre></div><p>Mount the external usb drive. In the example it has the Label &ldquo;usb0&rdquo;:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ls /dev/disk/by-label/usb0  <span style=color:#6272a4># check the device file exists</span>
</span></span><span style=display:flex><span>sudo mkdir -p /media/usb0  <span style=color:#6272a4># create the mountpoint</span>
</span></span><span style=display:flex><span>sudo mount -o defaults /dev/disk/by-label/usb0 /media/usb0
</span></span></code></pre></div><p>Copy all directories with dynamic data (at least <code>/tmp</code> and <code>/var</code>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo cp -ar /tmp/ /media/usb0/tmp
</span></span><span style=display:flex><span>sudo cp -ar /var/ /media/usb0/var
</span></span></code></pre></div><blockquote><p class=info>It&rsquo;s optional to copy <code>/tmp</code> as it only contains ephemeral data. But the directory must exist and have the correct permissions set!</p></blockquote><p>Add to <code>/etc/fstab</code> the new mount records:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>/dev/disk/by-label/usb0 /media/usb0 ext4 defaults 0 0
</span></span><span style=display:flex><span>/media/usb0/var         /var        none bind     0 0
</span></span><span style=display:flex><span>/media/usb0/tmp         /tmp        none bind     0 0
</span></span></code></pre></div><p>The external drive will be mounted to <code>/media/usb0</code>. The directories <code>/tmp</code> and <code>/var</code> (dynamic data) will be pointed to the corresponding directories on the external device.</p><blockquote><p class=warning>The external drive is mounted with option <code>defaults</code>. If the disk is not connected or cannot be read, the raspi will not boot! As a countermeasure the options <code>defaults,nofail</code> could be used. But then the data will be written to the SD card in case of a disk failure. Inconsistent data would be the result.</p></blockquote><p>Now reboot the Pi: <code>sudo reboot</code>.</p><p>Check that everything is working:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>touch /tmp/fs.test
</span></span><span style=display:flex><span>ls /media/usb0/fs/tmp/fs.test  <span style=color:#6272a4># should output the filepath</span>
</span></span></code></pre></div><p>If the swap is not reactivated yet, run <code>sudo swapon /var/swap</code>.</p><div class=comments><a href="https://github.com/knrdl/knrdl.github.io/issues/new?title=How+to+stop+your+Raspberry+Pi+from+eating+SD+Cards" target=_blank rel="noopener noreferrer"><img src=https://knrdl.github.io/github.png alt="Github logo" style=filter:invert(.7) width=17 height=17>
<span>Feedback</span></a></div></article></main><hr><footer>Licensed under <a href=https://creativecommons.org/publicdomain/zero/1.0/ target=_blank rel='noopener norefferer'>CC0 1.0</a> |
<a href=https://gohugo.io target=_blank rel='noopener norefferer'>Hugo</a> theme inspired by <a href=https://github.com/vamc19 target=_blank rel='noopener norefferer'>vamc19</a> |
Hosted by <a href=https://pages.github.com target=_blank rel='noopener norefferer'>Github</a> (<a href=https://github.com/site/privacy target=_blank rel='noopener norefferer'>Privacy Policy</a>)</footer></body></html>