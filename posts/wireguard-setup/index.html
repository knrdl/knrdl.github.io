<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta http-equiv=content-security-policy content="default-src 'none'; style-src 'self' 'unsafe-inline'; img-src 'self' https:; font-src 'self'; script-src 'unsafe-inline'"><link rel="shortcut icon" type=image/png href=/favicon.png><link rel=sitemap type=application/xml href=/sitemap.xml title=knrdlog><title>Wireguard: Client/Server - Setup</title><meta name=description content="notes to self"><meta property="og:title" content="Wireguard: Client/Server - Setup"><meta property="og:description" content="Approach Wireguard is a modern VPN protocol. Per default all nodes are treated equally, named peers. Let&rsquo;s build a point-to-point connection:
Client: Wireguard running, no port opened Server: Wireguard running, one port opened Wireguard uses UDP packets only. If an incoming request is invalid (wrong encryption key) then it will be dropped silently. Thereby additional security measures like fail2ban are not necessary.
Setup 1. Installation sudo apt install wireguard A docker based installation is possible."><meta property="og:type" content="article"><meta property="og:url" content="https://knrdl.github.io/posts/wireguard-setup/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-27T00:00:00+00:00"><meta property="article:modified_time" content="2022-09-27T22:17:27+02:00"><meta name=author content="knrdl"><link rel=stylesheet href=https://knrdl.github.io/styles.min.b1eb305989f01c7be31a7a19d4ab34ca470eddd06327253c7bcf3d1c5a41d28c.css integrity="sha256-seswWYnwHHvjGnoZ1Ks0ykcO3dBjJyU8e889HFpB0ow="></head><body><header><div class=site-header><span><a href=https://knrdl.github.io/ class=site-title>knrdlog</a></span>
<span><nav class=right-menu><span class=menu-item><a href=/tags/>tags</a></span>
<span class=menu-item><a href=https://github.com/knrdl target=_blank rel="noopener noreferrer">github</a></span>
<span class=menu-item><a href=/index.xml>rss</a></span></nav></span></div><div class=separator>================================================================================================================================================================</div></header><main><article><div class=post-header><h1>Wireguard: Client/Server - Setup</h1><time datetime=2022-09-27 class=pubdate>2022-09-27</time>
<span class=tags><a href=/tags/vpn class=hashtag>vpn</a>
<a href=/tags/wireguard class=hashtag>wireguard</a></span></div><h2 id=approach class=paragraph-header>Approach <a href=#approach></a></h2><p>Wireguard is a modern VPN protocol. Per default all nodes are treated equally, named peers. Let&rsquo;s build a point-to-point connection:</p><ul><li>Client: Wireguard running, <strong>no</strong> port opened</li><li>Server: Wireguard running, <strong>one</strong> port opened</li></ul><p>Wireguard uses UDP packets only. If an incoming request is invalid (wrong encryption key) then it will be dropped silently. Thereby additional security measures like fail2ban are not necessary.</p><h2 id=setup class=paragraph-header>Setup <a href=#setup></a></h2><h3 id=1-installation class=paragraph-header>1. Installation <a href=#1-installation></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo apt install wireguard
</span></span></code></pre></div><p>A docker based installation is
<a href=https://docs.linuxserver.io/images/docker-wireguard target=_blank rel="noopener noreferrer">possible</a>. But as wireguard requires a separate kernel module, there are no isolation benefits.</p><h3 id=2-generate-keys class=paragraph-header>2. Generate keys <a href=#2-generate-keys></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#6272a4># Client:</span>
</span></span><span style=display:flex><span>wg genkey &gt; client.key
</span></span><span style=display:flex><span>wg pubkey &lt; client.key &gt; client.pub
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># Server:</span>
</span></span><span style=display:flex><span>$ wg genkey &gt; server.key
</span></span><span style=display:flex><span>$ wg pubkey &lt; server.key &gt; server.pub
</span></span></code></pre></div><h3 id=3-config-files class=paragraph-header>3. Config files <a href=#3-config-files></a></h3><p>On the client in <code>/etc/wireguard/wg0.conf</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#ff79c6>[Interface]</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>PrivateKey</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>XXXXX  # client.key</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>Address</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>192.168.7.2/32</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>ListenPort</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>51822</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[Peer]</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>PublicKey</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>XXXXX  # server.pub</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>Endpoint</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>fqdn:51821  # public fqdn (domain) or static ip addr of the server</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>AllowedIPs</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>192.168.7.1/32</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>PersistentKeepalive</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>25</span>
</span></span></code></pre></div><p>On the server in <code>/etc/wireguard/wg0.conf</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#ff79c6>[Interface]</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>PrivateKey</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>XXXXX  # server.key</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>Address</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>192.168.7.1/32</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>ListenPort</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>51821</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[Peer]</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>PublicKey</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>XXXXX  # client.pub</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>AllowedIPs</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>192.168.7.2/32</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>PersistentKeepalive</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>25</span>
</span></span></code></pre></div><p>Wireguard won&rsquo;t send any messages per default if there is no traffic. If both peers provide an <code>Endpoint</code> in the config (Server - Server Setup), this works well. But in the presented setup keepalives are required for the client to contact the server. <code>PersistentKeepalive = 25</code> will send a ping every 25sec through the tunnel.</p><h3 id=4-up-and-running class=paragraph-header>4. Up and running <a href=#4-up-and-running></a></h3><p><code>wg-quick</code> is a convenient wrapper around the <code>wireguard</code> and <code>ip</code> commands. It allows to configure wireguard tunnels in a declarative fashion. Config files are stored as <code>/etc/wireguard/IFNAME.conf</code>.</p><p>Setup autostart on both hosts and check logs after startup:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo systemctl <span style=color:#8be9fd;font-style:italic>enable</span> --now wg-quick@wg0.service
</span></span><span style=display:flex><span>sudo journalctl -u wg-quick@wg0.service
</span></span></code></pre></div><h3 id=5-test-connection class=paragraph-header>5. Test connection <a href=#5-test-connection></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ping 192.168.7.2  <span style=color:#6272a4># on the server</span>
</span></span><span style=display:flex><span>ping 192.168.7.1  <span style=color:#6272a4># on the client</span>
</span></span></code></pre></div><h3 id=6-restart-a-tunnel class=paragraph-header>6. Restart a tunnel <a href=#6-restart-a-tunnel></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>wg-quick down wg0
</span></span><span style=display:flex><span>wg-quick up wg0
</span></span></code></pre></div><h2 id=usage class=paragraph-header>Usage <a href=#usage></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#6272a4># Server: bind a port to the wireguard tunnel address</span>
</span></span><span style=display:flex><span>docker run -it --rm -p 192.168.7.1:80:80 nginx:alpine
</span></span><span style=display:flex><span><span style=color:#6272a4># Client: query a connection</span>
</span></span><span style=display:flex><span>curl 192.168.7.1:80
</span></span></code></pre></div><h2 id=limitations class=paragraph-header>Limitations <a href=#limitations></a></h2><p>This wireguard setup is fairly simple. A tunneled client/server relation is realized.</p><p>However, there is no routing of container traffic through the tunnel in place. This would require additional network config on the server host.</p><div class=comments><a href="https://github.com/knrdl/knrdl.github.io/issues/new?title=Wireguard%3A+Client%2FServer+-+Setup" target=_blank rel="noopener noreferrer"><img src=https://knrdl.github.io/github.png alt="Github logo" style=filter:invert(.7) width=17 height=17>
<span>Feedback</span></a></div></article></main><hr><footer>Licensed under <a href=https://creativecommons.org/publicdomain/zero/1.0/ target=_blank rel='noopener norefferer'>CC0 1.0</a> |
<a href=https://gohugo.io target=_blank rel='noopener norefferer'>Hugo</a> theme inspired by <a href=https://github.com/vamc19 target=_blank rel='noopener norefferer'>vamc19</a> |
Hosted by <a href=https://pages.github.com target=_blank rel='noopener norefferer'>Github</a> (<a href=https://github.com/site/privacy target=_blank rel='noopener norefferer'>Privacy Policy</a>)</footer></body></html>