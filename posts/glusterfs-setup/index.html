<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta http-equiv=content-security-policy content="default-src 'none'; style-src 'self' 'unsafe-inline'; img-src 'self' https:; font-src 'self'; script-src 'unsafe-inline'"><link rel="shortcut icon" type=image/png href=/favicon.png><link rel=sitemap type=application/xml href=/sitemap.xml title=knrdlog><title>GlusterFs Setup</title><meta name=description content="notes to self"><meta property="og:title" content="GlusterFs Setup"><meta property="og:description" content="GlusterFs is a distributed storage layer based on the rsync algorithm
GlusterFs works great for semi-static files, but not for databases like sqlite or postgres!
Setup For best performance the traffic between nodes stays unencrypted. Such a glusterfs should only be operated in a dedicated, trustworthy network.
The following setup will create a storage cluster on 3 nodes (node1, node2, node3) as NAS RAID1 (mirroring)
1. On each node: sudo apt install --no-install-recommends glusterfs-server rpcbind sudo systemctl start glusterd."><meta property="og:type" content="article"><meta property="og:url" content="https://knrdl.github.io/posts/glusterfs-setup/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-11T00:00:00+00:00"><meta property="article:modified_time" content="2022-08-17T22:08:06+02:00"><meta name=author content="knrdl"><link rel=stylesheet href=https://knrdl.github.io/styles.min.e12cde4fe427445585f700d8463ce5ad7916721aee44e174dc3d324d2f5ca89e.css integrity="sha256-4SzeT+QnRFWF9wDYRjzlrXkWchruROF03D0yTS9cqJ4="></head><body><header><div class=site-header><span><a href=https://knrdl.github.io/ class=site-title>knrdlog</a></span>
<span><nav class=right-menu><span class=menu-item><a href=/tags/>tags</a></span>
<span class=menu-item><a href=https://github.com/knrdl target=_blank rel="noopener noreferrer">github</a></span>
<span class=menu-item><a href=/index.xml>rss</a></span></nav></span></div><div class=separator>================================================================================================================================================================</div></header><main><article><div class=post-header><h1>GlusterFs Setup</h1><time datetime=2022-04-11 class=pubdate>2022-04-11</time>
<time datetime=2022-08-17 class=lastmod>[Updated 2022-08-17]</time>
<span class=tags><a href=/tags/glusterfs class=hashtag>glusterfs</a>
<a href=/tags/storage class=hashtag>storage</a></span></div><p>GlusterFs is a distributed storage layer based on
the
<a href=https://www.andrew.cmu.edu/course/15-749/READINGS/required/cas/tridgell96.pdf target=_blank rel="noopener noreferrer">rsync algorithm</a></p><blockquote><p class=danger>GlusterFs works great for semi-static files, but not for databases like sqlite or postgres!</p></blockquote><h2 id=setup class=paragraph-header>Setup <a href=#setup></a></h2><p>For best performance the traffic between nodes stays unencrypted. Such a glusterfs should only be operated in a dedicated, trustworthy network.</p><p>The following setup will create a storage cluster on 3 nodes (node1, node2, node3) as NAS RAID1 (mirroring)</p><h3 id=1-on-each-node class=paragraph-header>1. On each node: <a href=#1-on-each-node></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt install --no-install-recommends glusterfs-server rpcbind
</span></span><span style=display:flex><span>sudo systemctl start glusterd.service
</span></span><span style=display:flex><span>sudo systemctl <span style=color:#8be9fd;font-style:italic>enable</span> glusterd.service
</span></span><span style=display:flex><span>sudo mkdir -p /media/storage0/gluster  <span style=color:#6272a4># where cluster data should be stored</span>
</span></span></code></pre></div><h3 id=2-on-primary-node class=paragraph-header>2. On primary node: <a href=#2-on-primary-node></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo gluster peer probe node1  <span style=color:#6272a4># replace node1 with real hostname</span>
</span></span><span style=display:flex><span>sudo gluster peer probe node2
</span></span><span style=display:flex><span>sudo gluster peer probe node3
</span></span><span style=display:flex><span>sudo gluster pool list
</span></span><span style=display:flex><span>sudo gluster volume create vol0 replica <span style=color:#bd93f9>3</span> node1:/media/storage0/gluster node2:/media/storage0/gluster node3:/media/storage0/gluster force
</span></span><span style=display:flex><span><span style=color:#6272a4># force is only necessary if /media/storage0/gluster is on at least one node mounted on the root partition (and not an additional partition / drive)</span>
</span></span><span style=display:flex><span>sudo gluster volume info
</span></span><span style=display:flex><span>sudo gluster volume start vol0
</span></span><span style=display:flex><span>sudo gluster volume <span style=color:#8be9fd;font-style:italic>set</span> vol0 auth.allow 127.0.0.1  
</span></span><span style=display:flex><span><span style=color:#6272a4># allow connections only from localhost (each gluster-node will mount their local storage, access from other hosts in network is prevented)</span>
</span></span><span style=display:flex><span>sudo gluster volume info
</span></span></code></pre></div><h3 id=3-on-each-node class=paragraph-header>3. On each node: <a href=#3-on-each-node></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo mkdir -p /media/gluster0  <span style=color:#6272a4># where gluster gets mounted</span>
</span></span><span style=display:flex><span>sudo chown -R 1000:1000 /media/gluster0
</span></span><span style=display:flex><span>sudo bash -c <span style=color:#f1fa8c>&#39;echo &#34;127.0.0.1:/vol0 /media/gluster0 glusterfs defaults,_netdev 0 0&#34; &gt;&gt; /etc/fstab&#39;</span>
</span></span><span style=display:flex><span>sudo mount -a
</span></span></code></pre></div><h3 id=4-test class=paragraph-header>4. Test: <a href=#4-test></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#6272a4># one one node: </span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;hello world&#34;</span> &gt; /media/gluster0/testfile
</span></span><span style=display:flex><span><span style=color:#6272a4># on another node:</span>
</span></span><span style=display:flex><span>cat /media/gluster0/testfile
</span></span><span style=display:flex><span>rm /media/gluster0/testfile
</span></span></code></pre></div><blockquote><p class=warning>Never write a file/dir directly to <code>/media/storage0/gluster</code>. GlusterFS won&rsquo;t be able to detect the changes, and they will not be synchronised.</p></blockquote><h3 id=5-on-each-node class=paragraph-header>5. On each node: <a href=#5-on-each-node></a></h3><p>Add the ip addresses of all nodes to the <code>/etc/hosts</code> files to prevent cluster split on DNS outages:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>192.168.123.2 node1
</span></span><span style=display:flex><span>192.168.123.3 node2
</span></span><span style=display:flex><span>192.168.123.4 node3
</span></span></code></pre></div><div class=comments><a href="https://github.com/knrdl/knrdl.github.io/issues/new?title=GlusterFs+Setup" target=_blank rel="noopener noreferrer"><img src=https://knrdl.github.io/github.png alt="Github logo" style=filter:invert(.7) width=17 height=17>
<span>Feedback</span></a></div></article></main><hr><footer>Licensed under <a href=https://creativecommons.org/publicdomain/zero/1.0/ target=_blank rel='noopener norefferer'>CC0 1.0</a> |
<a href=https://gohugo.io target=_blank rel='noopener norefferer'>Hugo</a> theme inspired by <a href=https://github.com/vamc19 target=_blank rel='noopener norefferer'>vamc19</a> |
Hosted by <a href=https://pages.github.com target=_blank rel='noopener norefferer'>Github</a> (<a href=https://github.com/site/privacy target=_blank rel='noopener norefferer'>Privacy Policy</a>)</footer></body></html>