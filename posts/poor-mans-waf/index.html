<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta http-equiv=Content-Security-Policy content="default-src 'none'; style-src 'self' 'unsafe-inline'; img-src 'self' https:; font-src 'self'; script-src 'unsafe-inline'"><link rel="shortcut icon" type=image/png href=/favicon.png><link rel=sitemap type=application/xml href=/sitemap.xml title=knrdlog><title>The poor man's WAF</title>
<meta name=description content="notes to self"><meta property="og:url" content="https://knrdl.github.io/posts/poor-mans-waf/"><meta property="og:site_name" content="knrdlog"><meta property="og:title" content="The poor man's WAF"><meta property="og:description" content="Every internet connected server is subject to automated scans and probes from various parties. On web servers they typically try to find exploitable installations by calling e.g. ///wordpress/wp-admin/setup-config.php?step=1. Another annoyance are web scrapers farming content for AI bot training and often enough ignoring therefore the robots.txt. These requests form a constant background noise which we don’t have to listen to. If you run a small home server only for friends and family you can configure the internet-facing reverse proxy to just drop these requests. I will use the excellent Caddy reverse proxy to build a poor man’s WAF."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-01-26T00:00:00+00:00"><meta property="article:modified_time" content="2025-01-26T13:52:37+01:00"><meta property="article:tag" content="Caddy"><meta property="article:tag" content="Ipfilter"><meta property="article:tag" content="Waf"><meta name=author content="knrdl"><link rel=stylesheet href=https://knrdl.github.io/styles.min.b1eb305989f01c7be31a7a19d4ab34ca470eddd06327253c7bcf3d1c5a41d28c.css integrity="sha256-seswWYnwHHvjGnoZ1Ks0ykcO3dBjJyU8e889HFpB0ow="></head><body><header><div class=site-header><span><a href=https://knrdl.github.io/ class=site-title>knrdlog</a>
</span><span><nav class=right-menu><span class=menu-item><a href=/tags/>tags</a></span>
<span class=menu-item><a href=https://github.com/knrdl target=_blank rel="noopener noreferrer">github</a></span>
<span class=menu-item><a href=/index.xml>rss</a></span></nav></span></div><div class=separator>================================================================================================================================================================</div></header><main><article><div class=post-header><h1>The poor man's WAF</h1><time datetime=2025-01-26 class=pubdate>2025-01-26</time>
<span class=tags><a href=/tags/caddy class=hashtag>caddy</a>
<a href=/tags/ipfilter class=hashtag>ipfilter</a>
<a href=/tags/waf class=hashtag>waf</a></span></div><p>Every internet connected server is subject to automated scans and probes from various parties. On web servers they typically try to find exploitable installations by calling e.g. <code>///wordpress/wp-admin/setup-config.php?step=1</code>. Another annoyance are web scrapers farming content for AI bot training and often enough ignoring therefore the robots.txt. These requests form a constant background noise which we don&rsquo;t have to listen to. If you run a small home server only for friends and family you can configure the internet-facing reverse proxy to just drop these requests. I will use the excellent
<a href=https://caddyserver.com/ target=_blank rel="noopener noreferrer">Caddy</a> reverse proxy to build a poor man&rsquo;s <abbr title="Web Application Firewall">WAF</abbr>.</p><h2 id=ip-filter class=paragraph-header>IP filter <a href=#ip-filter></a></h2><p>Some companies publish theirs IP address ranges used by their products, e.g.
<a href=https://ip-ranges.amazonaws.com/ip-ranges.json target=_blank rel="noopener noreferrer">AWS</a>,
<a href=https://api.cloudflare.com/client/v4/ips target=_blank rel="noopener noreferrer">Cloudflare</a>,
<a href=https://api.github.com/meta target=_blank rel="noopener noreferrer">GitHub</a>,
<a href=https://developers.google.com/search/apis/ipranges/googlebot.json target=_blank rel="noopener noreferrer">Googlebot</a>,
<a href=https://www.gstatic.com/ipranges/cloud.json target=_blank rel="noopener noreferrer">Google Cloud</a> or OpenAI
<a href=https://openai.com/searchbot.json target=_blank rel="noopener noreferrer">1</a>
<a href=https://openai.com/chatgpt-user.json target=_blank rel="noopener noreferrer">2</a>
<a href=https://openai.com/gptbot.json target=_blank rel="noopener noreferrer">3</a>. However, we only need to allow connections from residential or mobile IP addresses so we can block requests from these companies at all. Instead of relying on them to publish relevant IP ranges, we can block all their IPs. This in turn also includes cloud instances which might be used by AI companies for their scraping.</p><p>Every big internet company acts as an AS (autonomous system) and has an ASN (autonomous system number) assigned. Every AS manages their assigned IP ranges. So we can block IP ranges based on their AS. The assignment database can be grabbed from
<a href=https://ip.guide/bulk/networks.csv target=_blank rel="noopener noreferrer">here</a> among other places. This python script extracts the IP ranges for relevant companies:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff79c6>import</span> csv<span style=color:#ff79c6>,</span> fnmatch
</span></span><span style=display:flex><span><span style=color:#ff79c6>from</span> ipaddress <span style=color:#ff79c6>import</span> ip_network, IPv4Network, IPv6Network, collapse_addresses
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>block_filters <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#39;DigitalOcean*&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#39;Amazon.com*&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#39;Google*&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#39;Cloudflare*&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#39;Facebook*&#39;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#39;Microsoft*&#39;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#39;GitHub*&#39;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#39;Twitter*&#39;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#39;Hetzner*&#39;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#39;IBM*&#39;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#39;Akamai*&#39;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#39;Fly.io*&#39;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#39;Apple Inc.&#39;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#39;SAP *&#39;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#39;Oracle Corporation&#39;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#39;Yahoo Inc.&#39;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#39;Yahoo-UK Limited&#39;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#39;Opera Norway AS&#39;</span>,  <span style=color:#6272a4># Opera VPN</span>
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#39;Clouvider *&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#39;PacketHub *&#39;</span>  <span style=color:#6272a4># NordVPN</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>output: <span style=color:#8be9fd;font-style:italic>set</span>[IPv4Network <span style=color:#ff79c6>|</span> IPv6Network] <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>set</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># https://ip.guide/bulk/networks.csv</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>with</span> <span style=color:#8be9fd;font-style:italic>open</span>(<span style=color:#f1fa8c>&#39;networks.csv&#39;</span>) <span style=color:#ff79c6>as</span> f:
</span></span><span style=display:flex><span>    reader <span style=color:#ff79c6>=</span> csv<span style=color:#ff79c6>.</span>reader(f)
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>next</span>(reader, <span style=color:#ff79c6>None</span>)  <span style=color:#6272a4># skip the headers</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> network, asn, organization, country <span style=color:#ff79c6>in</span> reader:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> <span style=color:#8be9fd;font-style:italic>any</span>((fnmatch<span style=color:#ff79c6>.</span>fnmatchcase(organization, bf) <span style=color:#ff79c6>for</span> bf <span style=color:#ff79c6>in</span> block_filters)):
</span></span><span style=display:flex><span>            output<span style=color:#ff79c6>.</span>add(ip_network(network))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>with</span> <span style=color:#8be9fd;font-style:italic>open</span>(<span style=color:#f1fa8c>&#39;blocklist.txt&#39;</span>, <span style=color:#f1fa8c>&#39;w&#39;</span>) <span style=color:#ff79c6>as</span> f:         
</span></span><span style=display:flex><span>    f<span style=color:#ff79c6>.</span>write(
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#39; &#39;</span><span style=color:#ff79c6>.</span>join(
</span></span><span style=display:flex><span>            [n<span style=color:#ff79c6>.</span>with_prefixlen <span style=color:#ff79c6>for</span> n <span style=color:#ff79c6>in</span> <span style=color:#8be9fd;font-style:italic>sorted</span>(collapse_addresses([n <span style=color:#ff79c6>for</span> n <span style=color:#ff79c6>in</span> output <span style=color:#ff79c6>if</span> n<span style=color:#ff79c6>.</span>version <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>4</span>]))] <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>            [n<span style=color:#ff79c6>.</span>with_prefixlen <span style=color:#ff79c6>for</span> n <span style=color:#ff79c6>in</span> <span style=color:#8be9fd;font-style:italic>sorted</span>(collapse_addresses([n <span style=color:#ff79c6>for</span> n <span style=color:#ff79c6>in</span> output <span style=color:#ff79c6>if</span> n<span style=color:#ff79c6>.</span>version <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>6</span>]))]
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>    )
</span></span></code></pre></div><p>There are round about 54 000 matching IP ranges in the database. By using <code>collapse_addresses</code> these are unified into less than 11 000 IP ranges which can be added to the Caddy config:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#50fa7b>@ipfilter remote_ip 1.0.0.0/24 1.1.1.0/24 1.44.96.0/24 ...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>handle @ipfilter {</span>
</span></span><span style=display:flex><span>    <span style=color:#50fa7b>abort  # the request will be dropped by closing the connection</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>}</span>
</span></span></code></pre></div><h2 id=user-agent-filter class=paragraph-header>User Agent filter <a href=#user-agent-filter></a></h2><p>UA filtering is kind of snake oil as real attackers and stealthy crawlers won&rsquo;t bring their own UA. But at least we can release Internet Explorer users from their suffering:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#50fa7b>@uafilter `</span>
</span></span><span style=display:flex><span>    <span style=color:#50fa7b>header_regexp(&#39;User-Agent&#39;, &#39;MSIE&#39;) ||</span>
</span></span><span style=display:flex><span>    <span style=color:#50fa7b>header_regexp(&#39;User-Agent&#39;, &#39;Trident&#39;)</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>`</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>handle @uafilter {</span>
</span></span><span style=display:flex><span>    <span style=color:#50fa7b>abort</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>}</span>
</span></span></code></pre></div><p>You should never block UAs of tools like <code>curl</code> because at some point you might need them for debugging.</p><h2 id=path-filter class=paragraph-header>Path filter <a href=#path-filter></a></h2><p>As long as you don&rsquo;t run a PHP server (which you shouldn&rsquo;t) there is no need in answering PHP related requests:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#50fa7b>@pathfilter `</span>
</span></span><span style=display:flex><span>    <span style=color:#50fa7b>path_regexp(&#39;(?i)\\.php$&#39;)</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>`</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>handle @pathfilter {</span>
</span></span><span style=display:flex><span>    <span style=color:#50fa7b>abort</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>}</span>
</span></span></code></pre></div><h2 id=method-filter class=paragraph-header>Method filter <a href=#method-filter></a></h2><p>Modern web applications and REST APIs use a standard set of HTTP methods. Requests with deviant methods can be blocked by returning HTTP status code 405.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#50fa7b>@methodfilter `</span>
</span></span><span style=display:flex><span>    <span style=color:#50fa7b>!method(&#39;GET&#39;, &#39;HEAD&#39;, &#39;OPTIONS&#39;, &#39;POST&#39;, &#39;PUT&#39;, &#39;PATCH&#39;, &#39;DELETE&#39;)</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>`</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>handle @methodfilter {</span>
</span></span><span style=display:flex><span>    <span style=color:#50fa7b>respond 405 {</span>
</span></span><span style=display:flex><span>        <span style=color:#50fa7b>body &#34;method not allowed&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>}</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>}</span>
</span></span></code></pre></div><blockquote><p class=warning>Keep in mind that some protocols built on top of HTTP might use different methods. Especially CardDAV, CalDAV and WebDAV bring in a bunch of custom HTTP methods!</p></blockquote><div class=comments><a href="https://github.com/knrdl/knrdl.github.io/issues/new?title=The+poor+man%27s+WAF" target=_blank rel="noopener noreferrer"><img src=https://knrdl.github.io/github.png alt="Github logo" style=filter:invert(.7) width=17 height=17>
<span>Feedback</span></a></div></article></main><hr><footer>Licensed under <a href=https://creativecommons.org/publicdomain/zero/1.0/ target=_blank rel='noopener norefferer'>CC0 1.0</a> |
<a href=https://gohugo.io target=_blank rel='noopener norefferer'>Hugo</a> theme inspired by <a href=https://github.com/vamc19 target=_blank rel='noopener norefferer'>vamc19</a> |
Hosted by <a href=https://pages.github.com target=_blank rel='noopener norefferer'>Github</a> (<a href=https://github.com/site/privacy target=_blank rel='noopener norefferer'>Privacy Policy</a>)</footer></body></html>