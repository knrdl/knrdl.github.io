<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta http-equiv=content-security-policy content="default-src 'none'; style-src 'self' 'unsafe-inline'; img-src 'self'; font-src 'self'"><link rel="shortcut icon" type=image/png href=/favicon.png><link rel=sitemap type=application/xml href=/sitemap.xml title=knrdlog><title>Cleanup bloated postgres index</title><meta name=description content="notes to self"><meta property="og:title" content="Cleanup bloated postgres index"><meta property="og:description" content="1. find db byte sizes SELECT datname, pg_size_pretty(pg_database_size(datname)) FROM pg_database ORDER by pg_database_size(datname) DESC; 2. find tables + indices sizes select table_name, pg_size_pretty(pg_total_relation_size(quote_ident(table_name))) from information_schema.tables where table_schema = 'public' order by pg_total_relation_size(quote_ident(table_name)) desc; 3. recreate index REINDEX TABLE hungry; Conclusion index shrank from ~12GiB to ~800MiB"><meta property="og:type" content="article"><meta property="og:url" content="https://knrdl.github.io/posts/postgres-bloated-index/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-10T00:00:00+00:00"><meta property="article:modified_time" content="2022-04-11T13:44:05+02:00"><meta name=author content="knrdl"><link rel=stylesheet href=https://knrdl.github.io/style.min.04f851893e658e0184e5c88dc0cf82f809c75bdc7b13e27fe13d262eb488e27a.css integrity="sha256-BPhRiT5ljgGE5ciNwM+C+AnHW9x7E+J/4T0mLrSI4no="></head><body><header><div class=site-header><span><a href=https://knrdl.github.io/ class=site-title>knrdlog</a></span>
<span><nav class=right-menu><span class=menu-item>/<a href=https://github.com/knrdl target=_blank rel="noopener noreferrer">github</a></span>
<span class=menu-item>/<a href=/index.xml target=_blank rel="noopener noreferrer">rss</a></span></nav></span></div><div class=separator>================================================================================================================================================================</div></header><main><article><div class=post-header><h1>Cleanup bloated postgres index</h1><span class=pubdate>2022-04-10</span>
<span class=lastmod>[Updated 2022-04-11]</span>
<span class=tags><a href=/tags/devops class=hashtag>devops</a>
<a href=/tags/postgres class=hashtag>postgres</a>
<a href=/tags/sql class=hashtag>sql</a></span></div><h2 id=1-find-db-byte-sizes class=paragraph-header>1. find db byte sizes <a href=#1-find-db-byte-sizes></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#ff79c6>SELECT</span> datname, pg_size_pretty(pg_database_size(datname))
</span></span><span style=display:flex><span><span style=color:#ff79c6>FROM</span> pg_database
</span></span><span style=display:flex><span><span style=color:#ff79c6>ORDER</span> <span style=color:#ff79c6>by</span> pg_database_size(datname) <span style=color:#ff79c6>DESC</span>;
</span></span></code></pre></div><h2 id=2-find-tables--indices-sizes class=paragraph-header>2. find tables + indices sizes <a href=#2-find-tables--indices-sizes></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#ff79c6>select</span> <span style=color:#ff79c6>table_name</span>, pg_size_pretty(pg_total_relation_size(quote_ident(<span style=color:#ff79c6>table_name</span>)))
</span></span><span style=display:flex><span><span style=color:#ff79c6>from</span> information_schema.tables
</span></span><span style=display:flex><span><span style=color:#ff79c6>where</span> table_schema <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;public&#39;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>order</span> <span style=color:#ff79c6>by</span> pg_total_relation_size(quote_ident(<span style=color:#ff79c6>table_name</span>)) <span style=color:#ff79c6>desc</span>;
</span></span></code></pre></div><h2 id=3-recreate-index class=paragraph-header>3. recreate index <a href=#3-recreate-index></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#ff79c6>REINDEX</span> <span style=color:#ff79c6>TABLE</span> hungry;
</span></span></code></pre></div><h2 id=conclusion class=paragraph-header>Conclusion <a href=#conclusion></a></h2><p>index shrank from ~12GiB to ~800MiB</p><div class=comments><a href="https://github.com/knrdl/knrdl.github.io/issues/new?title=Cleanup+bloated+postgres+index" target=_blank rel="noopener noreferrer"><img src=https://knrdl.github.io/github.png alt="Github logo" style=filter:invert(.7) width=17 height=17>
<span>Feedback</span></a></div></article></main><hr><footer>Licensed under <a href=https://creativecommons.org/publicdomain/zero/1.0/ target=_blank rel='noopener norefferer'>CC0 1.0</a> |
<a href=https://gohugo.io target=_blank rel='noopener norefferer'>Hugo</a> theme by <a href=https://github.com/vamc19 target=_blank rel='noopener norefferer'>vamc19</a> |
Hosted by <a href=https://pages.github.com target=_blank rel='noopener norefferer'>Github</a> (<a href=https://github.com/site/privacy target=_blank rel='noopener norefferer'>Privacy Policy</a>)</footer></body></html>