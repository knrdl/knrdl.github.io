<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta http-equiv=content-security-policy content="default-src 'none'; style-src 'self' 'unsafe-inline'; img-src 'self'; font-src 'self'"><link rel="shortcut icon" type=image/png href=/favicon.png><link rel=sitemap type=application/xml href=/sitemap.xml title=knrdlog><title>Arduino: ESP as static webserver</title><meta name=description content="notes to self"><meta property="og:title" content="Arduino: ESP as static webserver"><meta property="og:description" content="The ESP8266/ESP32/NodeMCU boards firmware has builtin support to run a http server. It&rsquo;s possible to build a restful json api but also to serve static files.
Setup Arduino IDE → File → Preferences → Additional Board Manager URLs: http://arduino.esp8266.com/stable/package_esp8266com_index.json Connect to Wifi #include <ESP8266WiFi.h> #include <WiFiClient.h> const char *ssid = &#34;YOUR_NETWORK_NAME&#34;; const char *password = &#34;YOUR_NETWORK_PASSWORD&#34;; void setup(void) { WiFi.mode(WIFI_STA); // stationary mode WiFi.begin(ssid, password); // Wait for connection while (WiFi."><meta property="og:type" content="article"><meta property="og:url" content="https://knrdl.github.io/posts/arduino-esp-static-webserver/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-13T00:00:00+00:00"><meta property="article:modified_time" content="2022-04-13T23:43:58+02:00"><meta name=author content="knrdl"><link rel=stylesheet href=https://knrdl.github.io/style.min.2d9821d02922aa178b656e839ee56d212542d3284e1d9b64f023e09937c9a55d.css integrity="sha256-LZgh0CkiqheLZW6DnuVtISVC0yhOHZtk8CPgmTfJpV0="></head><body><header><div class=site-header><span><a href=https://knrdl.github.io/ class=site-title>knrdlog</a></span>
<span><nav class=right-menu><span class=menu-item>/<a href=https://github.com/knrdl target=_blank rel="noopener noreferrer">github</a></span>
<span class=menu-item>/<a href=/index.xml target=_blank rel="noopener noreferrer">rss</a></span></nav></span></div><div class=separator>================================================================================================================================================================</div></header><main><article><div class=post-header><h1>Arduino: ESP as static webserver</h1><span class=pubdate>2022-04-13</span>
<span class=tags><a href=/tags/arduino class=hashtag>arduino</a>
<a href=/tags/c++ class=hashtag>c++</a>
<a href=/tags/webserver class=hashtag>webserver</a></span></div><p>The ESP8266/ESP32/NodeMCU boards firmware has builtin support to run a http server. It&rsquo;s possible to build a restful
json api but also to serve static files.</p><h2 id=setup class=paragraph-header>Setup <a href=#setup></a></h2><p>Arduino IDE → File → Preferences → Additional Board Manager
URLs:
<a href=http://arduino.esp8266.com/stable/package_esp8266com_index.json target=_blank rel="noopener noreferrer">http://arduino.esp8266.com/stable/package_esp8266com_index.json</a></p><h2 id=connect-to-wifi class=paragraph-header>Connect to Wifi <a href=#connect-to-wifi></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;ESP8266WiFi.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;WiFiClient.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>ssid <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;YOUR_NETWORK_NAME&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>password <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;YOUR_NETWORK_PASSWORD&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>setup</span>(<span style=color:#8be9fd>void</span>) {
</span></span><span style=display:flex><span>  WiFi.mode(WIFI_STA);  <span style=color:#6272a4>// stationary mode
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  WiFi.begin(ssid, password);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>// Wait for connection
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  <span style=color:#ff79c6>while</span> (WiFi.status() <span style=color:#ff79c6>!=</span> WL_CONNECTED) {
</span></span><span style=display:flex><span>    delay(<span style=color:#bd93f9>50</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>loop</span>(<span style=color:#8be9fd>void</span>) {
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=basic-api-server class=paragraph-header>Basic API Server <a href=#basic-api-server></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;ESP8266WiFi.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;WiFiClient.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;ESP8266WebServer.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span>ESP8266WebServer <span style=color:#50fa7b>server</span>(<span style=color:#bd93f9>80</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>inline</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>handleNotFound</span>() {
</span></span><span style=display:flex><span>  server.send(<span style=color:#bd93f9>404</span>, <span style=color:#f1fa8c>&#34;text/plain&#34;</span>, <span style=color:#f1fa8c>&#34;404 not found&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>inline</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>serveInfo</span>() {
</span></span><span style=display:flex><span>  String json <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;{&#34;</span>;
</span></span><span style=display:flex><span>  json <span style=color:#ff79c6>+=</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\&#34;</span><span style=color:#f1fa8c>free_heap</span><span style=color:#f1fa8c>\&#34;</span><span style=color:#f1fa8c>:&#34;</span> <span style=color:#ff79c6>+</span> String(ESP.getFreeHeap());
</span></span><span style=display:flex><span>  json <span style=color:#ff79c6>+=</span> <span style=color:#f1fa8c>&#34;,</span><span style=color:#f1fa8c>\&#34;</span><span style=color:#f1fa8c>heap_frag_perc</span><span style=color:#f1fa8c>\&#34;</span><span style=color:#f1fa8c>:&#34;</span> <span style=color:#ff79c6>+</span> String(ESP.getHeapFragmentation());
</span></span><span style=display:flex><span>  json <span style=color:#ff79c6>+=</span> <span style=color:#f1fa8c>&#34;,</span><span style=color:#f1fa8c>\&#34;</span><span style=color:#f1fa8c>last_reset_reason</span><span style=color:#f1fa8c>\&#34;</span><span style=color:#f1fa8c>:</span><span style=color:#f1fa8c>\&#34;</span><span style=color:#f1fa8c>&#34;</span> <span style=color:#ff79c6>+</span> String(ESP.getResetReason()) <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\&#34;</span><span style=color:#f1fa8c>&#34;</span>;
</span></span><span style=display:flex><span>  json <span style=color:#ff79c6>+=</span> <span style=color:#f1fa8c>&#34;,</span><span style=color:#f1fa8c>\&#34;</span><span style=color:#f1fa8c>uptime</span><span style=color:#f1fa8c>\&#34;</span><span style=color:#f1fa8c>:&#34;</span> <span style=color:#ff79c6>+</span> String(millis() <span style=color:#ff79c6>/</span> <span style=color:#bd93f9>1000</span>);
</span></span><span style=display:flex><span>  json <span style=color:#ff79c6>+=</span> <span style=color:#f1fa8c>&#34;,</span><span style=color:#f1fa8c>\&#34;</span><span style=color:#f1fa8c>cpu_freq</span><span style=color:#f1fa8c>\&#34;</span><span style=color:#f1fa8c>:&#34;</span> <span style=color:#ff79c6>+</span> String(ESP.getCpuFreqMHz());
</span></span><span style=display:flex><span>  json <span style=color:#ff79c6>+=</span> <span style=color:#f1fa8c>&#34;,</span><span style=color:#f1fa8c>\&#34;</span><span style=color:#f1fa8c>wifi_rssi</span><span style=color:#f1fa8c>\&#34;</span><span style=color:#f1fa8c>:&#34;</span> <span style=color:#ff79c6>+</span> String(WiFi.RSSI());
</span></span><span style=display:flex><span>  json <span style=color:#ff79c6>+=</span> <span style=color:#f1fa8c>&#34;,</span><span style=color:#f1fa8c>\&#34;</span><span style=color:#f1fa8c>ip</span><span style=color:#f1fa8c>\&#34;</span><span style=color:#f1fa8c>:</span><span style=color:#f1fa8c>\&#34;</span><span style=color:#f1fa8c>&#34;</span> <span style=color:#ff79c6>+</span> WiFi.localIP().toString() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\&#34;</span><span style=color:#f1fa8c>&#34;</span>;
</span></span><span style=display:flex><span>  json <span style=color:#ff79c6>+=</span> <span style=color:#f1fa8c>&#34;,</span><span style=color:#f1fa8c>\&#34;</span><span style=color:#f1fa8c>mac</span><span style=color:#f1fa8c>\&#34;</span><span style=color:#f1fa8c>:</span><span style=color:#f1fa8c>\&#34;</span><span style=color:#f1fa8c>&#34;</span> <span style=color:#ff79c6>+</span> WiFi.macAddress() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\&#34;</span><span style=color:#f1fa8c>&#34;</span>;
</span></span><span style=display:flex><span>  json <span style=color:#ff79c6>+=</span> <span style=color:#f1fa8c>&#34;}&#34;</span>;
</span></span><span style=display:flex><span>  server.send(<span style=color:#bd93f9>200</span>, <span style=color:#f1fa8c>&#34;application/json&#34;</span>, json);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>setup</span>(<span style=color:#8be9fd>void</span>) {
</span></span><span style=display:flex><span>  server.on(<span style=color:#f1fa8c>&#34;/api/system&#34;</span>, serveInfo);
</span></span><span style=display:flex><span>  server.onNotFound(handleNotFound);
</span></span><span style=display:flex><span>  server.begin();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>loop</span>(<span style=color:#8be9fd>void</span>) {
</span></span><span style=display:flex><span>  server.handleClient();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=static-file-server class=paragraph-header>Static file server <a href=#static-file-server></a></h2><p>There a few more steps to take here:</p><ol><li>Aggregate files which should be served by the arduino</li><li>Flash files from computer to a filesystem on the arduino board</li><li>Serve files from the arduino filesystem via http.</li></ol><h3 id=littlefs class=paragraph-header>LittleFS <a href=#littlefs></a></h3><p>LittleFS is a filesystem for microcontrollers. It supports path-based read/write operations:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&#34;LittleFS.h&#34;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>inline</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>writeFile</span>(<span style=color:#ff79c6>const</span> String path, <span style=color:#ff79c6>const</span> String message) {
</span></span><span style=display:flex><span>  File file <span style=color:#ff79c6>=</span> LittleFS.open(path, <span style=color:#f1fa8c>&#34;w&#34;</span>);
</span></span><span style=display:flex><span>  file.print(message);
</span></span><span style=display:flex><span>  file.close();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>inline</span> String <span style=color:#50fa7b>readFile</span>(<span style=color:#ff79c6>const</span> String path) {
</span></span><span style=display:flex><span>  File file <span style=color:#ff79c6>=</span> LittleFS.open(path, <span style=color:#f1fa8c>&#34;r&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>file <span style=color:#ff79c6>||</span> file.isDirectory()) {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> <span style=color:#f1fa8c>&#34;&#34;</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>const</span> String message <span style=color:#ff79c6>=</span> file.readString();
</span></span><span style=display:flex><span>  file.close();
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>return</span> message;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=fileserver class=paragraph-header>Fileserver <a href=#fileserver></a></h3><p>A webserver to serve files from a single directory (e.g. <code>/index.html</code>, <code>/styles.css</code>, <code>/main.js</code>, &mldr;) based on
LittleFS would look like this:</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style=background-color:#3d3f4a><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></span><span style=background-color:#3d3f4a><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></span><span style=background-color:#3d3f4a><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;ESP8266WebServer.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&#34;LittleFS.h&#34;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;uri/UriBraces.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span>ESP8266WebServer <span style=color:#50fa7b>server</span>(<span style=color:#bd93f9>80</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>inline</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>serveStaticFiles</span>() {
</span></span><span style=display:flex><span>  String filename <span style=color:#ff79c6>=</span> server.pathArg(<span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span>  filename.replace(<span style=color:#f1fa8c>&#34;..&#34;</span>, <span style=color:#f1fa8c>&#34;&#34;</span>);  <span style=color:#6272a4>// mitigate path traversal attacks
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  filename.replace(<span style=color:#f1fa8c>&#34;/&#34;</span>, <span style=color:#f1fa8c>&#34;&#34;</span>);  <span style=color:#6272a4>// serve from a single folder only
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  filename.trim();
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>if</span> (filename <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#34;&#34;</span>) {
</span></span><span style=display:flex><span>    filename <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;index.html&#34;</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  String path <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;/www/&#34;</span> <span style=color:#ff79c6>+</span> filename;  <span style=color:#6272a4>// assuming files are served from /www/
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  <span style=color:#ff79c6>const</span> String contentType <span style=color:#ff79c6>=</span> mime<span style=color:#ff79c6>::</span>getContentType(path);
</span></span><span style=display:flex;background-color:#3d3f4a><span>  <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>LittleFS.exists(path)) {
</span></span><span style=display:flex;background-color:#3d3f4a><span>    path <span style=color:#ff79c6>=</span> path <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;.gz&#34;</span>;  <span style=color:#6272a4>// explained in compression section below
</span></span></span><span style=display:flex;background-color:#3d3f4a><span><span style=color:#6272a4></span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>LittleFS.exists(path)) {
</span></span><span style=display:flex><span>    server.send(<span style=color:#bd93f9>404</span>, <span style=color:#f1fa8c>&#34;text/plain&#34;</span>, <span style=color:#f1fa8c>&#34;404 not found&#34;</span>);
</span></span><span style=display:flex><span>  } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>    File file <span style=color:#ff79c6>=</span> LittleFS.open(path, <span style=color:#f1fa8c>&#34;r&#34;</span>);
</span></span><span style=display:flex><span>    server.streamFile(file, contentType);
</span></span><span style=display:flex><span>    file.close();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>setup</span>(<span style=color:#8be9fd>void</span>) {
</span></span><span style=display:flex><span>  LittleFS.begin();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  server.on(UriBraces(<span style=color:#f1fa8c>&#34;/{}&#34;</span>), serveStaticFiles);
</span></span><span style=display:flex><span>  server.begin();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>loop</span>(<span style=color:#8be9fd>void</span>) {
</span></span><span style=display:flex><span>  server.handleClient();
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=setup-1 class=paragraph-header>Setup <a href=#setup-1></a></h3><p>To flash files to the arduino an additional library for Arduino IDE is required:</p><ol><li><a href=https://github.com/earlephilhower/arduino-esp8266littlefs-plugin target=_blank rel="noopener noreferrer">https://github.com/earlephilhower/arduino-esp8266littlefs-plugin</a></li><li>unpack to <code>~/Arduino/tools/ESP8266LittleFS/tool/esp8266littlefs.jar</code></li><li>Restart Arduino IDE</li><li>In Arduino IDE: Tools → ESP8266 Little FS Data Upload</li><li>It will upload all files (and dirs) in the <code>data</code> directory, which needs to be in the same folder as the
sketch (<code>.ino</code>
file)</li></ol><h3 id=compression class=paragraph-header>Compression <a href=#compression></a></h3><p>The ESP8266 runs at 80MHz cpu frequency (can be changed to 160MHz). Transferring large files takes some time (e.g. more
than a second for a couple of megabytes).</p><p>So pre-compressing files might improve performance. The following script gzips all files in the <code>www</code> dir and saves them
to <code>data/www</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#ff79c6>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#ff79c6></span>rm -rf data/www
</span></span><span style=display:flex><span>mkdir -p data/www
</span></span><span style=display:flex><span><span style=color:#ff79c6>for</span> filename in ./www/*; <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span>   cat <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$filename</span><span style=color:#f1fa8c>&#34;</span> | gzip -9 &gt; <span style=color:#f1fa8c>&#34;data/</span><span style=color:#8be9fd;font-style:italic>$filename</span><span style=color:#f1fa8c>.gz&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>done</span>
</span></span></code></pre></div><p>So when using the &ldquo;ESP8266 Little FS Data Upload&rdquo; button only the compressed versions will be uploaded (as <code>/www/...</code> on
the arduino). The server can handle pre-compressed files because of the precaution in Lines 17-19 of the server script
above. The correct http response header <code>Content-Encoding: gzip</code> will be automatically set by the command on Line 24.</p><div class=comments><a href="https://github.com/knrdl/knrdl.github.io/issues/new?title=Arduino%3A+ESP+as+static+webserver" target=_blank rel="noopener noreferrer"><img src=https://knrdl.github.io/github.png alt="Github logo" style=filter:invert(.7) width=17 height=17>
<span>Feedback</span></a></div></article></main><hr><footer>Licensed under <a href=https://creativecommons.org/publicdomain/zero/1.0/ target=_blank rel='noopener norefferer'>CC0 1.0</a> |
<a href=https://gohugo.io target=_blank rel='noopener norefferer'>Hugo</a> theme by <a href=https://github.com/vamc19 target=_blank rel='noopener norefferer'>vamc19</a> |
Hosted by <a href=https://pages.github.com target=_blank rel='noopener norefferer'>Github</a> (<a href=https://github.com/site/privacy target=_blank rel='noopener norefferer'>Privacy Policy</a>)</footer></body></html>