<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta http-equiv=Content-Security-Policy content="default-src 'none'; style-src 'self' 'unsafe-inline'; img-src 'self' https:; font-src 'self'; script-src 'unsafe-inline'"><link rel="shortcut icon" type=image/png href=/favicon.png><link rel=sitemap type=application/xml href=/sitemap.xml title=knrdlog><title>How to use IBM DB2 with async python</title>
<meta name=description content="notes to self"><meta property="og:url" content="https://knrdl.github.io/posts/db2-async-python/"><meta property="og:site_name" content="knrdlog"><meta property="og:title" content="How to use IBM DB2 with async python"><meta property="og:description" content="Async Python Async frameworks are nowadays the standard for web development with python. FastAPI didn’t invent it, but is currently the most successful and popular web framework offering it. With the increasing popularity of async, the need for async libraries grew over time. Python’s standard library is sync only for historic reasons. So async packages filled the gap and sometimes replaced the old sync libraries, e.g.:
DNS: std socket → aiodns Docker Client: docker → aiodocker File IO: std open → aiofiles HTTP Client: requests → aiohttp, httpx Postgres: psycopg2 → psycopg3, asyncpg SMTP Client: std smtplib → aiosmtplib Webserver: flask 1 → flask 2, fastapi IBM DB2 However, some old-fashioned libraries haven’t adapted yet and maybe never will, like the clunky ibm-db package to connect to an IBM DB2 database. The package consists of a C driver and python interface (IMHO, the latter looks like it was poorly written by absolute python beginners together with naysayers to the idea that python code could be pythonic at all)."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-12-06T00:00:00+00:00"><meta property="article:modified_time" content="2024-12-06T23:53:23+01:00"><meta property="article:tag" content="Databases"><meta property="article:tag" content="Python"><meta property="article:tag" content="Fastapi"><meta name=author content="knrdl"><link rel=stylesheet href=https://knrdl.github.io/styles.min.b1eb305989f01c7be31a7a19d4ab34ca470eddd06327253c7bcf3d1c5a41d28c.css integrity="sha256-seswWYnwHHvjGnoZ1Ks0ykcO3dBjJyU8e889HFpB0ow="></head><body><header><div class=site-header><span><a href=https://knrdl.github.io/ class=site-title>knrdlog</a>
</span><span><nav class=right-menu><span class=menu-item><a href=/tags/>tags</a></span>
<span class=menu-item><a href=https://github.com/knrdl target=_blank rel="noopener noreferrer">github</a></span>
<span class=menu-item><a href=/index.xml>rss</a></span></nav></span></div><div class=separator>================================================================================================================================================================</div></header><main><article><div class=post-header><h1>How to use IBM DB2 with async python</h1><time datetime=2024-12-06 class=pubdate>2024-12-06</time>
<span class=tags><a href=/tags/databases class=hashtag>databases</a>
<a href=/tags/fastapi class=hashtag>fastapi</a>
<a href=/tags/python class=hashtag>python</a></span></div><h2 id=async-python class=paragraph-header>Async Python <a href=#async-python></a></h2><p>Async frameworks are nowadays the standard for web development with python.
<a href=https://fastapi.tiangolo.com/ target=_blank rel="noopener noreferrer">FastAPI</a> didn&rsquo;t invent it, but is currently the most successful and popular web framework offering it. With the increasing popularity of async, the need for async libraries grew over time. Python&rsquo;s standard library is sync only for historic reasons. So
<a href=https://github.com/aio-libs target=_blank rel="noopener noreferrer">async packages filled the gap</a> and sometimes replaced the old sync libraries, e.g.:</p><ul><li>DNS:
<a href=https://docs.python.org/3/library/socket.html target=_blank rel="noopener noreferrer">std socket</a> <strong>→</strong>
<a href=https://pypi.org/project/aiodns/ target=_blank rel="noopener noreferrer">aiodns</a></li><li>Docker Client:
<a href=https://pypi.org/project/docker/ target=_blank rel="noopener noreferrer">docker</a> <strong>→</strong>
<a href=https://pypi.org/project/aiodocker/ target=_blank rel="noopener noreferrer">aiodocker</a></li><li>File IO:
<a href=https://docs.python.org/3/library/functions.html#open target=_blank rel="noopener noreferrer">std open</a> <strong>→</strong>
<a href=https://pypi.org/project/aiofiles/ target=_blank rel="noopener noreferrer">aiofiles</a></li><li>HTTP Client:
<a href=https://pypi.org/project/requests/ target=_blank rel="noopener noreferrer">requests</a> <strong>→</strong>
<a href=https://pypi.org/project/aiohttp/ target=_blank rel="noopener noreferrer">aiohttp</a>,
<a href=https://pypi.org/project/httpx/ target=_blank rel="noopener noreferrer">httpx</a></li><li>Postgres:
<a href=https://pypi.org/project/psycopg2/ target=_blank rel="noopener noreferrer">psycopg2</a> <strong>→</strong>
<a href=https://pypi.org/project/psycopg/ target=_blank rel="noopener noreferrer">psycopg3</a>,
<a href=https://pypi.org/project/asyncpg/ target=_blank rel="noopener noreferrer">asyncpg</a></li><li>SMTP Client:
<a href=https://docs.python.org/3/library/smtplib.html target=_blank rel="noopener noreferrer">std smtplib</a> <strong>→</strong>
<a href=https://pypi.org/project/aiosmtplib/ target=_blank rel="noopener noreferrer">aiosmtplib</a></li><li>Webserver:
<a href=https://pypi.org/project/Flask/ target=_blank rel="noopener noreferrer">flask 1</a> <strong>→</strong>
<a href=https://pypi.org/project/Flask/ target=_blank rel="noopener noreferrer">flask 2</a>,
<a href=https://pypi.org/project/fastapi/ target=_blank rel="noopener noreferrer">fastapi</a></li></ul><h2 id=ibm-db2 class=paragraph-header>IBM DB2 <a href=#ibm-db2></a></h2><p>However, some old-fashioned libraries haven&rsquo;t adapted yet and maybe never will, like the clunky
<a href=https://pypi.org/project/ibm-db/ target=_blank rel="noopener noreferrer">ibm-db</a> package to connect to an IBM DB2 database. The package consists of a
<a href=https://github.com/ibmdb/python-ibmdb/blob/master/ibm_db.c target=_blank rel="noopener noreferrer">C driver</a> and
<a href=https://github.com/ibmdb/python-ibmdb/blob/master/ibm_db_dbi.py target=_blank rel="noopener noreferrer">python interface</a> (IMHO, the latter looks like it was poorly written by absolute python beginners together with naysayers to the idea that python code could be pythonic at all).</p><p>So the problem is to run the sync lib
<a href=https://pypi.org/project/ibm-db/ target=_blank rel="noopener noreferrer"><em>ibm-db</em></a> in an async context, like a FastAPI webserver. The standard approach is to use <code>asyncio.to_thread()</code> to delegate the sync tasks (db access operations) into additional threads to free the event loop on the main thread. As <em>ibm-db</em> is not subject to the
<a href=https://wiki.python.org/moin/GlobalInterpreterLock target=_blank rel="noopener noreferrer">GIL</a> there should be no disadvantage except the overhead of spawning threads. But <em>ibm-db</em> is also not thread-safe. Multiple threads interact with a DB2 instance result in race conditions, connection abortions and incomplete result set responses. So <em>ibm-db</em> cannot be used in async nor multithreaded environments. So the workaround is to run <em>ibm-db</em> in (at most) one dedicated thread, but never in the main thread to keep the event loop free. This can be achieved with Python&rsquo;s
<a href=https://docs.python.org/3/library/concurrent.futures.html#threadpoolexecutor target=_blank rel="noopener noreferrer"><code>ThreadPoolExecutor</code></a> and the constraint <code>max_workers=1</code>. See code below.</p><h3 id=old-code-blocks-the-async-loop class=paragraph-header>Old code (blocks the async loop) <a href=#old-code-blocks-the-async-loop></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff79c6>import</span> ibm_db_dbi <span style=color:#ff79c6>as</span> db2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>run_query</span>():
</span></span><span style=display:flex><span>    conn: db2<span style=color:#ff79c6>.</span>Connection <span style=color:#ff79c6>=</span> db2<span style=color:#ff79c6>.</span>pconnect(dsn<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;...&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>with</span> conn<span style=color:#ff79c6>.</span>cursor() <span style=color:#ff79c6>as</span> cursor:
</span></span><span style=display:flex><span>        cursor<span style=color:#ff79c6>.</span>execute(<span style=color:#f1fa8c>&#39;select 1+1 from SYSIBM.SYSDUMMY1&#39;</span>)
</span></span><span style=display:flex><span>        result <span style=color:#ff79c6>=</span> cursor<span style=color:#ff79c6>.</span>fetchone()
</span></span><span style=display:flex><span>    conn<span style=color:#ff79c6>.</span>close()
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> result
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>print</span>(run_query())  <span style=color:#6272a4># blocks event loop</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>print</span>(run_query())  <span style=color:#6272a4># blocks event loop</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>print</span>(run_query())  <span style=color:#6272a4># blocks event loop</span>
</span></span></code></pre></div><h3 id=new-code-frees-the-async-loop class=paragraph-header>New code (frees the async loop) <a href=#new-code-frees-the-async-loop></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff79c6>import</span> asyncio
</span></span><span style=display:flex><span><span style=color:#ff79c6>from</span> concurrent.futures <span style=color:#ff79c6>import</span> ThreadPoolExecutor
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> ibm_db_dbi <span style=color:#ff79c6>as</span> db2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>_executor <span style=color:#ff79c6>=</span> ThreadPoolExecutor(max_workers<span style=color:#ff79c6>=</span><span style=color:#bd93f9>1</span>, thread_name_prefix<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;db2&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>async</span> <span style=color:#ff79c6>def</span> <span style=color:#50fa7b>run_query</span>():  <span style=color:#6272a4># can be invoked concurrently</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>def</span> <span style=color:#50fa7b>do</span>():
</span></span><span style=display:flex><span>        conn: db2<span style=color:#ff79c6>.</span>Connection <span style=color:#ff79c6>=</span> db2<span style=color:#ff79c6>.</span>pconnect(dsn<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;...&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>with</span> conn<span style=color:#ff79c6>.</span>cursor() <span style=color:#ff79c6>as</span> cursor:
</span></span><span style=display:flex><span>            cursor<span style=color:#ff79c6>.</span>execute(<span style=color:#f1fa8c>&#39;select 1+1 from SYSIBM.SYSDUMMY1&#39;</span>)
</span></span><span style=display:flex><span>            result <span style=color:#ff79c6>=</span> cursor<span style=color:#ff79c6>.</span>fetchone()
</span></span><span style=display:flex><span>        conn<span style=color:#ff79c6>.</span>close()
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> result
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>await</span> asyncio<span style=color:#ff79c6>.</span>get_event_loop()<span style=color:#ff79c6>.</span>run_in_executor(_executor, do)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#ff79c6>await</span> run_query())  <span style=color:#6272a4># does not block the event loop</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#ff79c6>await</span> run_query())  <span style=color:#6272a4># does not block the event loop</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#ff79c6>await</span> run_query())  <span style=color:#6272a4># does not block the event loop</span>
</span></span></code></pre></div><div class=comments><a href="https://github.com/knrdl/knrdl.github.io/issues/new?title=How+to+use+IBM+DB2+with+async+python" target=_blank rel="noopener noreferrer"><img src=https://knrdl.github.io/github.png alt="Github logo" style=filter:invert(.7) width=17 height=17>
<span>Feedback</span></a></div></article></main><hr><footer>Licensed under <a href=https://creativecommons.org/publicdomain/zero/1.0/ target=_blank rel='noopener norefferer'>CC0 1.0</a> |
<a href=https://gohugo.io target=_blank rel='noopener norefferer'>Hugo</a> theme inspired by <a href=https://github.com/vamc19 target=_blank rel='noopener norefferer'>vamc19</a> |
Hosted by <a href=https://pages.github.com target=_blank rel='noopener norefferer'>Github</a> (<a href=https://github.com/site/privacy target=_blank rel='noopener norefferer'>Privacy Policy</a>)</footer></body></html>