<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta http-equiv=Content-Security-Policy content="default-src 'none'; style-src 'self' 'unsafe-inline'; img-src 'self' https:; font-src 'self'; script-src 'unsafe-inline'"><link rel="shortcut icon" type=image/png href=/favicon.png><link rel=sitemap type=application/xml href=/sitemap.xml title=knrdlog><title>Postgres: Fast row count estimates</title>
<meta name=description content="notes to self"><meta property="og:url" content="https://knrdl.github.io/posts/postgres-fast-row-count/"><meta property="og:site_name" content="knrdlog"><meta property="og:title" content="Postgres: Fast row count estimates"><meta property="og:description" content="Counting rows in postgresql is as easy as select count(1) from mytable. This is a precise count. But it becomes slow on an increasing number of records, especially when a sequential scan of all table records is required, see explain select count(1) from mytable. But in the end the user often doesnâ€™t care if there are about 125_000_000 or exactly 124_756_849 results. Therefore, a fast row count estimate might be more desirable than a slow precise count."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-04-28T00:00:00+00:00"><meta property="article:modified_time" content="2023-04-28T16:15:26+02:00"><meta property="article:tag" content="Postgres"><meta property="article:tag" content="Sql"><meta property="article:tag" content="Python"><meta name=author content="knrdl"><link rel=stylesheet href=https://knrdl.github.io/styles.min.b1eb305989f01c7be31a7a19d4ab34ca470eddd06327253c7bcf3d1c5a41d28c.css integrity="sha256-seswWYnwHHvjGnoZ1Ks0ykcO3dBjJyU8e889HFpB0ow="></head><body><header><div class=site-header><span><a href=https://knrdl.github.io/ class=site-title>knrdlog</a>
</span><span><nav class=right-menu><span class=menu-item><a href=/tags/>tags</a></span>
<span class=menu-item><a href=https://github.com/knrdl target=_blank rel="noopener noreferrer">github</a></span>
<span class=menu-item><a href=/index.xml>rss</a></span></nav></span></div><div class=separator>================================================================================================================================================================</div></header><main><article><div class=post-header><h1>Postgres: Fast row count estimates</h1><time datetime=2023-04-28 class=pubdate>2023-04-28</time>
<span class=tags><a href=/tags/postgres class=hashtag>postgres</a>
<a href=/tags/python class=hashtag>python</a>
<a href=/tags/sql class=hashtag>sql</a></span></div><p>Counting rows in postgresql is as easy as <code>select count(1) from mytable</code>. This is a precise count. But it becomes slow on an increasing number of records, especially when a sequential scan of all table records is required, see <code>explain select count(1) from mytable</code>. But in the end the user often doesn&rsquo;t care if there are about 125_000_000 or exactly 124_756_849 results. Therefore, a fast row count estimate might be more desirable than a slow precise count.</p><p>Postgres runs internal statistics for the query planner to produce performant decisions. These statistics also include estimates of row counts. They are updated regularly by autovacuum or manually by <code>analyze mytable</code>. The later one is only necessary to get better results on very recent insert/delete batches.</p><p>This snippet uses the postgres statistics to estimate the row count:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python3 data-lang=python3><span style=display:flex><span><span style=color:#ff79c6>import</span> psycopg2
</span></span><span style=display:flex><span>conn  <span style=color:#ff79c6>=</span> psycopg2<span style=color:#ff79c6>.</span>connect(os<span style=color:#ff79c6>.</span>getenv(<span style=color:#f1fa8c>&#39;DB_DSN&#39;</span>))
</span></span><span style=display:flex><span>cur <span style=color:#ff79c6>=</span> conn<span style=color:#ff79c6>.</span>cursor()
</span></span><span style=display:flex><span>cur<span style=color:#ff79c6>.</span>execute(<span style=color:#f1fa8c>&#39;explain (format json) select * from mytable;&#39;</span>)
</span></span><span style=display:flex><span>res <span style=color:#ff79c6>=</span> cur<span style=color:#ff79c6>.</span>fetchone()
</span></span><span style=display:flex><span>row_count <span style=color:#ff79c6>=</span> res[<span style=color:#bd93f9>0</span>][<span style=color:#bd93f9>0</span>][<span style=color:#f1fa8c>&#39;Plan&#39;</span>][<span style=color:#f1fa8c>&#39;Plan Rows&#39;</span>]
</span></span></code></pre></div><div class=comments><a href="https://github.com/knrdl/knrdl.github.io/issues/new?title=Postgres%3A+Fast+row+count+estimates" target=_blank rel="noopener noreferrer"><img src=https://knrdl.github.io/github.png alt="Github logo" style=filter:invert(.7) width=17 height=17>
<span>Feedback</span></a></div></article></main><hr><footer>Licensed under <a href=https://creativecommons.org/publicdomain/zero/1.0/ target=_blank rel='noopener norefferer'>CC0 1.0</a> |
<a href=https://gohugo.io target=_blank rel='noopener norefferer'>Hugo</a> theme inspired by <a href=https://github.com/vamc19 target=_blank rel='noopener norefferer'>vamc19</a> |
Hosted by <a href=https://pages.github.com target=_blank rel='noopener norefferer'>Github</a> (<a href=https://github.com/site/privacy target=_blank rel='noopener norefferer'>Privacy Policy</a>)</footer></body></html>