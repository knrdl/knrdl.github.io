<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta http-equiv=content-security-policy content="default-src 'none'; style-src 'self' 'unsafe-inline'; img-src 'self' https:; font-src 'self'; script-src 'unsafe-inline'"><link rel="shortcut icon" type=image/png href=/favicon.png><link rel=sitemap type=application/xml href=/sitemap.xml title=knrdlog><title>Conceptualize Docker Networks to be minimal</title><meta name=description content="notes to self"><meta property="og:title" content="Conceptualize Docker Networks to be minimal"><meta property="og:description" content="Introduction There are three kinds of private ip ranges:
Class CIDR Last IP IPs Typical Usage A 10.0.0.0/8 10.255.255.255 16,777,216 Big Company Network B 172.16.0.0/12 172.31.255.255 1,048,576 Docker Network! C 192.168.0.0/16 192.168.255.255 65,536 Home Network So there are about a million IPs available for docker containers in docker networks. However, docker per default splits them up as /24 CIDRs. Therefore, every docker network can include up to 2 (32-24) - 2 = 254 Container-IPs."><meta property="og:type" content="article"><meta property="og:url" content="https://knrdl.github.io/posts/minimal-docker-networks/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-10T00:00:00+00:00"><meta property="article:modified_time" content="2022-09-11T17:35:27+02:00"><meta name=author content="knrdl"><link rel=stylesheet href=https://knrdl.github.io/style.min.a11d1b2a21f42b4d45b54290a85c2e1b3f0569440311041ccfdf866fcfcd0744.css integrity="sha256-oR0bKiH0K01FtUKQqFwuGz8FaUQDEQQcz9+Gb8/NB0Q="></head><body><header><div class=site-header><span><a href=https://knrdl.github.io/ class=site-title>knrdlog</a></span>
<span><nav class=right-menu><span class=menu-item>/<a href=/tags/ target=_blank rel="noopener noreferrer">tags</a></span>
<span class=menu-item>/<a href=https://github.com/knrdl target=_blank rel="noopener noreferrer">github</a></span>
<span class=menu-item>/<a href=/index.xml target=_blank rel="noopener noreferrer">rss</a></span></nav></span></div><div class=separator>================================================================================================================================================================</div></header><main><article><div class=post-header><h1>Conceptualize Docker Networks to be minimal</h1><span class=pubdate>2022-09-10</span>
<span class=lastmod>[Updated 2022-09-11]</span>
<span class=tags><a href=/tags/docker class=hashtag>docker</a></span></div><h2 id=introduction class=paragraph-header>Introduction <a href=#introduction></a></h2><p>There are three kinds of private ip ranges:</p><table><thead><tr><th>Class</th><th>CIDR</th><th>Last IP</th><th>IPs</th><th>Typical Usage</th></tr></thead><tbody><tr><td>A</td><td>10.0.0.0/8</td><td>10.255.255.255</td><td>16,777,216</td><td>Big Company Network</td></tr><tr><td>B</td><td>172.16.0.0/12</td><td>172.31.255.255</td><td>1,048,576</td><td><em><strong>Docker Network!</strong></em></td></tr><tr><td>C</td><td>192.168.0.0/16</td><td>192.168.255.255</td><td>65,536</td><td>Home Network</td></tr></tbody></table><p>So there are about a million IPs available for docker containers in docker networks. However, docker per default splits them up as /24 CIDRs. Therefore, every docker network can include up to<math>
<msup>
<mi>2</mi>
<mrow>
(<mn>32</mn><mo>-</mo><mn>24</mn>)
</mrow>
</msup>
<mo>-</mo>
<mn>2</mn>
<mo>=</mo>
<mn>254</mn>
</math>
Container-IPs. The total number of docker networks is limited to
<math>
<msup>
<mi>2</mi>
<mrow>
(<mn>24</mn><mo>-</mo><mn>12</mn>)
</mrow>
</msup>
<mo>=</mo>
<mn>4096</mn>
</math>.</p><p>While these defaults are okay, it&rsquo;s possible to run out of address spaces, <strong>especially if private Class B addresses are used elsewhere</strong> (by other applications/routing). Using more docker networks with fewer containers per network has two benefits: Security and Safety.</p><h2 id=security--safety class=paragraph-header>Security & Safety <a href=#security--safety></a></h2><ol><li><p>Scenario with three containers: gateway, appserver, database.</p><p>It&rsquo;s easy to put all three of them in a single docker network. But this would allow the gateway to access the database, which is not required. Therefore, 2 docker networks should be utilized.</p></li><li><p>Scenario with three containers: gateway, appserver1, appserver2.</p><p>Using a single network to connect the appservers to the gateway, allows appserver1 to talk to appserver2. This might not be desired, if app1 and app2 are two distinct applications.</p></li></ol><p>The security gain is a better separation of trust levels, following the principle of least privilege. Anyway, an advanced attacker can still try OSI-Layer 2 (&ldquo;MAC-Level&rdquo;) sniffing attacks.</p><p>The bigger gain is the safety of the container environment. The impact of configuration mistakes is limited. The architecture is clearer: Confusion about what service the hostname &ldquo;app&rdquo; belongs to is hopefully prevented.</p><p>The cost of this approach is that there might be more docker networks needed than the 4096 possible ones. A config change allows to create more networks.</p><blockquote><p class=info>This is just an example! 4096 is a reasonable amount of networks. But if there is only a subspace of private class B addresses available or class C must be used, then things might look different. Per default max 256 docker networks can be produced in class C, which could be limiting.</p></blockquote><h2 id=configuration class=paragraph-header>Configuration <a href=#configuration></a></h2><p>In <code>/etc/docker/daemon.json</code> add:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>&#34;default-address-pools&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>&#34;base&#34;</span>: <span style=color:#f1fa8c>&#34;172.16.0.0/12&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>&#34;size&#34;</span>: <span style=color:#bd93f9>27</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This will use the complete Class B private namespace (<code>172.16.0.0/12</code>). The CIDR per docker network is /27.</p><p>Max docker networks per host:<math>
<msup>
<mi>2</mi>
<mrow>
(<mn>27</mn><mo>-</mo><mn>12</mn>)
</mrow>
</msup>
<mo>=</mo>
<mn>32,768</mn>
</math></p><p>Max containers per docker network:<math>
<msup>
<mi>2</mi>
<mrow>
(<mn>32</mn><mo>-</mo><mn>27</mn>)
</mrow>
</msup>
<mo>-</mo>
<mn>2</mn>
<mo>=</mo>
<mn>30</mn>
</math></p><div class=comments><a href="https://github.com/knrdl/knrdl.github.io/issues/new?title=Conceptualize+Docker+Networks+to+be+minimal" target=_blank rel="noopener noreferrer"><img src=https://knrdl.github.io/github.png alt="Github logo" style=filter:invert(.7) width=17 height=17>
<span>Feedback</span></a></div></article></main><hr><footer>Licensed under <a href=https://creativecommons.org/publicdomain/zero/1.0/ target=_blank rel='noopener norefferer'>CC0 1.0</a> |
<a href=https://gohugo.io target=_blank rel='noopener norefferer'>Hugo</a> theme inspired by <a href=https://github.com/vamc19 target=_blank rel='noopener norefferer'>vamc19</a> |
Hosted by <a href=https://pages.github.com target=_blank rel='noopener norefferer'>Github</a> (<a href=https://github.com/site/privacy target=_blank rel='noopener norefferer'>Privacy Policy</a>)</footer></body></html>