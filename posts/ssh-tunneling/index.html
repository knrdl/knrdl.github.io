<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta http-equiv=content-security-policy content="default-src 'none'; style-src 'self' 'unsafe-inline'; img-src 'self' https:; font-src 'self'; script-src 'unsafe-inline'"><link rel="shortcut icon" type=image/png href=/favicon.png><link rel=sitemap type=application/xml href=/sitemap.xml title=knrdlog><title>SSH Tunneling</title><meta name=description content="notes to self"><meta property="og:title" content="SSH Tunneling"><meta property="og:description" content="SSH allows tcp port forwarding between ssh client and ssh server as part of the encrypted ssh connection.
Server → Client (local) A socket on the server (source) gets forwarded to the client (target).
ssh user@host -L target_ip:target_port:source_ip:source_port Use case 1: Admin software Server socket with port 9000 will be available on client machine at port 5000.
ssh user@host -L 127.0.0.1:5000:127.0.0.1:9000 Useful if admin software is only accessible on the server (localhost binding) and not exposed to the network."><meta property="og:type" content="article"><meta property="og:url" content="https://knrdl.github.io/posts/ssh-tunneling/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-13T00:00:00+00:00"><meta property="article:modified_time" content="2022-04-13T13:13:29+02:00"><meta name=author content="knrdl"><link rel=stylesheet href=https://knrdl.github.io/styles.min.e12cde4fe427445585f700d8463ce5ad7916721aee44e174dc3d324d2f5ca89e.css integrity="sha256-4SzeT+QnRFWF9wDYRjzlrXkWchruROF03D0yTS9cqJ4="></head><body><header><div class=site-header><span><a href=https://knrdl.github.io/ class=site-title>knrdlog</a></span>
<span><nav class=right-menu><span class=menu-item><a href=/tags/>tags</a></span>
<span class=menu-item><a href=https://github.com/knrdl target=_blank rel="noopener noreferrer">github</a></span>
<span class=menu-item><a href=/index.xml>rss</a></span></nav></span></div><div class=separator>================================================================================================================================================================</div></header><main><article><div class=post-header><h1>SSH Tunneling</h1><time datetime=2022-04-13 class=pubdate>2022-04-13</time>
<span class=tags><a href=/tags/rsync class=hashtag>rsync</a>
<a href=/tags/sftp class=hashtag>sftp</a>
<a href=/tags/ssh class=hashtag>ssh</a></span></div><p>SSH allows tcp port forwarding between ssh client and ssh server as part of the encrypted ssh connection.</p><h2 id=server--client-local class=paragraph-header>Server → Client (local) <a href=#server--client-local></a></h2><p>A socket on the server (source) gets forwarded to the client (target).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ssh user@host -L target_ip:target_port:source_ip:source_port
</span></span></code></pre></div><h3 id=use-case-1-admin-software class=paragraph-header>Use case 1: Admin software <a href=#use-case-1-admin-software></a></h3><p>Server socket with port 9000 will be available on client machine at port 5000.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ssh user@host -L 127.0.0.1:5000:127.0.0.1:9000
</span></span></code></pre></div><p>Useful if admin software is only accessible on the server (localhost binding) and not exposed to the network.</p><h3 id=use-case-2-quick-demo class=paragraph-header>Use Case 2: Quick demo <a href=#use-case-2-quick-demo></a></h3><p>Server socket with port 9000 will be accessible at client network on port 8080 of the client machine.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ssh user@host -L 8080:127.0.0.1:9000
</span></span><span style=display:flex><span>ssh user@host -L 0.0.0.0:8080:127.0.0.1:9000
</span></span></code></pre></div><p>Useful for a quick demo of a service running in a different network (e.g. cloud) to multiple participants in the same
network (e.g. company).</p><h3 id=use-case-3-jump-host class=paragraph-header>Use case 3: Jump Host <a href=#use-case-3-jump-host></a></h3><p>Server can reach host with ip addr 192.168.1.15. Service on 192.168.1.15:8080 will be available on client machine at
port 8081.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ssh user@host -L 127.0.0.1:8081:192.168.1.15:8080
</span></span></code></pre></div><p>Hop to hop forwarding of hosts accessible in the server network(s).</p><h2 id=client--server-remote class=paragraph-header>Client → Server (remote) <a href=#client--server-remote></a></h2><p>A socket on the client (source) gets forwarded to the server (target).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ssh user@host -R target_port:source_ip:source_port
</span></span></code></pre></div><h3 id=use-case-1-microservice-development class=paragraph-header>Use case 1: Microservice development <a href=#use-case-1-microservice-development></a></h3><p>Service on port 8000 of the client machine will be available on server at port 8081. Unless <code>GatewayPorts</code> is set
to <code>yes</code> in sshd config (default <code>no</code>) the serverside bind will always be localhost (127.0.0.1).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ssh user@host -R 8081:127.0.0.1:8000
</span></span></code></pre></div><p>Useful to integrate a microservice on developer machine into a foreign environment (e.g. test cluster). Also works with
other source addresses than <code>127.0.0.1</code>.</p><h3 id=use-case-2-tls-terminating-web-proxy-as-a-service class=paragraph-header>Use case 2: TLS terminating web proxy as a service <a href=#use-case-2-tls-terminating-web-proxy-as-a-service></a></h3><p>Client starts a http server on local machine on port 8000. That service will be available as
<a href=https://server.tld target=_blank rel="noopener noreferrer">https://server.tld</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ssh user@host -R 8001:127.0.0.1:8000
</span></span></code></pre></div><p>Processing order:</p><ol><li>Webbrowser (User Agent) requests
<a href=https://server.tld target=_blank rel="noopener noreferrer">https://server.tld</a></li><li>Reaches a reverse proxy on port 443<ul><li>does tls termination</li><li>and proxying, nginx: <code>proxy_pass 127.0.0.1:8001;</code></li></ul></li><li>SSH Tunnel</li><li>local machine port 8000 http server</li></ol><h2 id=ssh-config class=paragraph-header>SSH Config <a href=#ssh-config></a></h2><p>port forwarding can also be specified on the client in <code>~/.ssh/config</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-text data-lang=text><span style=display:flex><span>Host server-01
</span></span><span style=display:flex><span>	HostName	192.168.1.2
</span></span><span style=display:flex><span>	Port		22
</span></span><span style=display:flex><span>	User		clusteradm
</span></span><span style=display:flex;background-color:#3d3f4a><span>	LocalForward	localhost:9001 localhost:9000
</span></span><span style=display:flex;background-color:#3d3f4a><span>	RemoteForward	8001 localhost:8000
</span></span><span style=display:flex><span>	KeepAlive	yes
</span></span><span style=display:flex><span>	IdentitiesOnly	yes
</span></span><span style=display:flex><span>	IdentityFile	~/.ssh/server_01_clusteradm
</span></span></code></pre></div><p>Config format is <code>(Local|Remote)Forward target source</code></p><p>connect via <code>$ ssh server-01</code></p><h2 id=persistent-connections class=paragraph-header>Persistent connections <a href=#persistent-connections></a></h2><p>Just use the <code>autossh</code> command in place of <code>ssh</code>. AutoSSH uses heartbeats to check if the connection is still open and
open another one otherwise automatically and fully transparent.</p><h2 id=dedicated-tunneling-server class=paragraph-header>Dedicated tunneling server <a href=#dedicated-tunneling-server></a></h2><p>It&rsquo;s possible to run a standalone ssh server which just allows port forwarding and no remote command execution. Setup:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mkdir -p /jail
</span></span><span style=display:flex><span>adduser --gecos <span style=color:#f1fa8c>&#34;&#34;</span> --no-create-home --shell /bin/false --disabled-password --uid <span style=color:#bd93f9>1000</span> sshtunnel
</span></span></code></pre></div><p>Excerpt from <code>/etc/ssh/sshd_config</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#6272a4># AllowUsers list all users which should be able to login</span>
</span></span><span style=display:flex><span>AllowUsers sshtunnel
</span></span><span style=display:flex><span>Match User sshtunnel
</span></span><span style=display:flex><span>  PermitTTY no
</span></span><span style=display:flex><span>  Banner none
</span></span><span style=display:flex><span>  X11Forwarding no
</span></span><span style=display:flex><span>  AllowAgentForwarding no
</span></span><span style=display:flex><span>  <span style=color:#6272a4># AllowTcpForwarding: yes (= local+remote), local, remote, no</span>
</span></span><span style=display:flex><span>  AllowTcpForwarding <span style=color:#8be9fd;font-style:italic>local</span>
</span></span><span style=display:flex><span>  GatewayPorts no
</span></span><span style=display:flex><span>  PermitTunnel no
</span></span><span style=display:flex><span>  ChrootDirectory /jail
</span></span><span style=display:flex><span>  ForceCommand /bin/false
</span></span><span style=display:flex><span>  PermitOpen 127.0.0.1:8730
</span></span></code></pre></div><p>Start sshd in foreground: <code>$ sshd -D -e</code></p><p>Connect client: <code>$ ssh -N -L 127.0.0.1:8730:127.0.0.1:8730 sshtunnel@localhost</code></p><p>Flag <code>-N</code> prevents the spawning of a shell (which would result in a connection abortion otherwise).</p><h2 id=rsync-tunneling-also-sftp class=paragraph-header>Rsync tunneling (also sftp) <a href=#rsync-tunneling-also-sftp></a></h2><p><code>rsync</code> can copy (sync) files between hosts. Therefore, it can use ssh as a transfer protocol. But that implies running
the rsync command on the server:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>rsync -av -e ssh user@host:/backup/ /datadir/
</span></span></code></pre></div><p>That won&rsquo;t work with a tunneling only ssh server. Luckily rsync can also be operated with a standalone server, so the
rsync protocol can be tunneled via ssh.</p><h3 id=server-setup class=paragraph-header>Server Setup <a href=#server-setup></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>adduser --gecos <span style=color:#f1fa8c>&#34;&#34;</span> --no-create-home --shell /bin/false --disabled-password --uid <span style=color:#bd93f9>1001</span> rsyncbackup
</span></span><span style=display:flex><span>sudo mkdir -p /jail/backup
</span></span><span style=display:flex><span>sudo chown -R root:root /jail  <span style=color:#6272a4># user cannot have write permission to chroot dir</span>
</span></span><span style=display:flex><span>sudo chown -R rsyncbackup:rsyncbackup /jail/backup
</span></span><span style=display:flex><span>sudo chmod -R <span style=color:#bd93f9>755</span> /jail/backup
</span></span></code></pre></div><p>Excerpt from <code>/etc/ssh/sshd_config</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#6272a4># allow sftp connections</span>
</span></span><span style=display:flex><span>Subsystem sftp internal-sftp
</span></span><span style=display:flex><span><span style=color:#6272a4># AllowUsers list all users which should be able to login</span>
</span></span><span style=display:flex><span>AllowUsers rsyncbackup
</span></span><span style=display:flex><span>Match User rsyncbackup
</span></span><span style=display:flex><span>  PermitTTY no
</span></span><span style=display:flex><span>  Banner none
</span></span><span style=display:flex><span>  X11Forwarding no
</span></span><span style=display:flex><span>  AllowAgentForwarding no
</span></span><span style=display:flex><span>  <span style=color:#6272a4># AllowTcpForwarding: yes (= local+remote), local, remote, no</span>
</span></span><span style=display:flex><span>  AllowTcpForwarding <span style=color:#8be9fd;font-style:italic>local</span>
</span></span><span style=display:flex><span>  GatewayPorts no
</span></span><span style=display:flex><span>  PermitTunnel no
</span></span><span style=display:flex><span>  ChrootDirectory /jail
</span></span><span style=display:flex><span>  ForceCommand internal-sftp
</span></span><span style=display:flex><span>  PermitOpen 127.0.0.1:8730
</span></span></code></pre></div><p>In addition to rsync this config also allows file browsing via sftp in the <code>/jail</code> dir.</p><p>Rsync server config in <code>/etc/rsyncd.conf</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>use <span style=color:#8be9fd;font-style:italic>chroot</span> <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>true</span>
</span></span><span style=display:flex><span>hosts <span style=color:#8be9fd;font-style:italic>allow</span> <span style=color:#ff79c6>=</span> 127.0.0.1/32
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>port</span> <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>8730</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>timeout</span> <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>300</span>
</span></span><span style=display:flex><span>max <span style=color:#8be9fd;font-style:italic>connections</span> <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span>reverse <span style=color:#8be9fd;font-style:italic>lookup</span> <span style=color:#ff79c6>=</span> no
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>log <span style=color:#8be9fd;font-style:italic>file</span> <span style=color:#ff79c6>=</span> /dev/stdout
</span></span><span style=display:flex><span>log <span style=color:#8be9fd;font-style:italic>format</span> <span style=color:#ff79c6>=</span> %h %o %f %l %b
</span></span><span style=display:flex><span>pid <span style=color:#8be9fd;font-style:italic>file</span> <span style=color:#ff79c6>=</span> /var/run/rsyncd.pid
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>backup_sink<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>comment</span> <span style=color:#ff79c6>=</span> Backup
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>path</span> <span style=color:#ff79c6>=</span> /jail
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>read</span> <span style=color:#8be9fd;font-style:italic>only</span> <span style=color:#ff79c6>=</span> no
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>list</span> <span style=color:#ff79c6>=</span> yes
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>uid</span> <span style=color:#ff79c6>=</span> rsyncbackup
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>gid</span> <span style=color:#ff79c6>=</span> rsyncbackup
</span></span></code></pre></div><p>Start rsync server: <code>$ rsync --daemon --config /etc/rsyncd.conf</code></p><h3 id=client-setup class=paragraph-header>Client Setup <a href=#client-setup></a></h3><p>Record in <code>.ssh/config</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span> Host				backup-conn
</span></span><span style=display:flex><span>     HostName		192.168.1.32
</span></span><span style=display:flex><span>     Port			<span style=color:#bd93f9>2201</span>
</span></span><span style=display:flex><span>     User			rsyncbackup
</span></span><span style=display:flex><span>     KeepAlive		yes
</span></span><span style=display:flex><span>     LocalForward	127.0.0.1:8730 127.0.0.1:8730
</span></span></code></pre></div><p>Run a rsync job:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ssh -N backup-conn &amp;  <span style=color:#6272a4># no tty possible, either use pubkey-auth or use sshpass to submit the password</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>pid</span><span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>$!</span>
</span></span><span style=display:flex><span>sleep <span style=color:#bd93f9>3</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>time</span> rsync bigfile rsync://localhost:8730/backup_sink/backup
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>kill</span> <span style=color:#8be9fd;font-style:italic>$pid</span>
</span></span></code></pre></div><p>Check that <code>/jail/backup/bigfile</code> has been created on the server.</p><div class=comments><a href="https://github.com/knrdl/knrdl.github.io/issues/new?title=SSH+Tunneling" target=_blank rel="noopener noreferrer"><img src=https://knrdl.github.io/github.png alt="Github logo" style=filter:invert(.7) width=17 height=17>
<span>Feedback</span></a></div></article></main><hr><footer>Licensed under <a href=https://creativecommons.org/publicdomain/zero/1.0/ target=_blank rel='noopener norefferer'>CC0 1.0</a> |
<a href=https://gohugo.io target=_blank rel='noopener norefferer'>Hugo</a> theme inspired by <a href=https://github.com/vamc19 target=_blank rel='noopener norefferer'>vamc19</a> |
Hosted by <a href=https://pages.github.com target=_blank rel='noopener norefferer'>Github</a> (<a href=https://github.com/site/privacy target=_blank rel='noopener norefferer'>Privacy Policy</a>)</footer></body></html>