<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta http-equiv=Content-Security-Policy content="default-src 'none'; style-src 'self' 'unsafe-inline'; img-src 'self' https:; font-src 'self'; script-src 'unsafe-inline'"><link rel="shortcut icon" type=image/png href=/favicon.png><link rel=sitemap type=application/xml href=/sitemap.xml title=knrdlog><title>Minimal setup for a docker host</title>
<meta name=description content="notes to self"><meta property="og:title" content="Minimal setup for a docker host"><meta property="og:description" content='Install docker Comes with Docker Compose as $ docker compose
sudo apt-get update sudo apt-get install ca-certificates curl gnupg lsb-release curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \ $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null sudo apt-get update sudo apt-get install docker-ce docker-ce-cli containerd.io docker-compose-plugin Check docker is running: $ docker version
Enable swap If not enabled yet
fallocate -l 8G /swapfile sudo chmod 600 /swapfile sudo mkswap /swapfile sudo swapon /swapfile sudo swapon --show Add to /etc/fstab:'><meta property="og:type" content="article"><meta property="og:url" content="https://knrdl.github.io/posts/minimal-docker-host-setup/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-11-01T00:00:00+00:00"><meta property="article:modified_time" content="2023-01-08T12:23:47+01:00"><meta name=author content="knrdl"><link rel=stylesheet href=https://knrdl.github.io/styles.min.b1eb305989f01c7be31a7a19d4ab34ca470eddd06327253c7bcf3d1c5a41d28c.css integrity="sha256-seswWYnwHHvjGnoZ1Ks0ykcO3dBjJyU8e889HFpB0ow="></head><body><header><div class=site-header><span><a href=https://knrdl.github.io/ class=site-title>knrdlog</a>
</span><span><nav class=right-menu><span class=menu-item><a href=/tags/>tags</a></span>
<span class=menu-item><a href=https://github.com/knrdl target=_blank rel="noopener noreferrer">github</a></span>
<span class=menu-item><a href=/index.xml>rss</a></span></nav></span></div><div class=separator>================================================================================================================================================================</div></header><main><article><div class=post-header><h1>Minimal setup for a docker host</h1><time datetime=2022-11-01 class=pubdate>2022-11-01</time>
<a href=https://github.com/knrdl/knrdl.github.io/commits/main/content/posts/minimal-docker-host-setup.md target=_blank rel="noopener noreferrer"><time datetime=2023-01-08 class=lastmod>{üìù2023-01-08}
</time></a><span class=tags><a href=/tags/devops class=hashtag>devops</a>
<a href=/tags/docker class=hashtag>docker</a>
<a href=/tags/ubuntu class=hashtag>ubuntu</a></span></div><h2 id=install-docker class=paragraph-header>Install docker <a href=#install-docker></a></h2><p>Comes with Docker Compose as <code>$ docker compose</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo apt-get update
</span></span><span style=display:flex><span>sudo apt-get install ca-certificates curl gnupg lsb-release
</span></span><span style=display:flex><span>curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>echo</span>   <span style=color:#f1fa8c>&#34;deb [arch=</span><span style=color:#ff79c6>$(</span>dpkg --print-architecture<span style=color:#ff79c6>)</span><span style=color:#f1fa8c> signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     </span><span style=color:#ff79c6>$(</span>lsb_release -cs<span style=color:#ff79c6>)</span><span style=color:#f1fa8c> stable&#34;</span> | sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null
</span></span><span style=display:flex><span>sudo apt-get update
</span></span><span style=display:flex><span>sudo apt-get install docker-ce docker-ce-cli containerd.io docker-compose-plugin
</span></span></code></pre></div><p>Check docker is running: <code>$ docker version</code></p><h2 id=enable-swap class=paragraph-header>Enable swap <a href=#enable-swap></a></h2><p>If not enabled yet</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>fallocate -l 8G /swapfile
</span></span><span style=display:flex><span>sudo chmod <span style=color:#bd93f9>600</span> /swapfile
</span></span><span style=display:flex><span>sudo mkswap /swapfile
</span></span><span style=display:flex><span>sudo swapon /swapfile
</span></span><span style=display:flex><span>sudo swapon --show
</span></span></code></pre></div><p>Add to <code>/etc/fstab</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>/swapfile swap swap defaults <span style=color:#bd93f9>0</span> <span style=color:#bd93f9>0</span>
</span></span></code></pre></div><p>Optional reboot to check if it worked</p><h2 id=enable-fail2ban class=paragraph-header>Enable fail2ban <a href=#enable-fail2ban></a></h2><p>Necessary if ssh is accessible over the internet</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo apt install fail2ban
</span></span><span style=display:flex><span>sudo systemctl <span style=color:#8be9fd;font-style:italic>enable</span> --now fail2ban
</span></span></code></pre></div><p>Statistics of failed attempts:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>awk <span style=color:#f1fa8c>&#39;($(NF-1) = /Ban/){print $NF}&#39;</span> /var/log/fail2ban.log | sort | uniq -c | sort -n
</span></span></code></pre></div><p>try to log in with wrong passwords to check banning is working!</p><h2 id=useful-shortcuts class=paragraph-header>Useful shortcuts <a href=#useful-shortcuts></a></h2><p>Add to <code>~/.bashrc</code>:</p><pre tabindex=0><code>alias dc=&#39;docker compose&#39;
alias dclf=&#39;docker compose logs --follow&#39;
alias dcup=&#39;docker compose up --detach --remove-orphans --build&#39;
</code></pre><p>Test in new terminal or run <code>source ~/.bashrc</code></p><h2 id=docker-hardening class=paragraph-header>Docker Hardening <a href=#docker-hardening></a></h2><p>Disable inter container communication (ICC) via <code>/etc/docker/daemon.json</code>, add:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>&#34;icc&#34;</span>: <span style=color:#ff79c6>false</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Might also want to justify address pool, see
<a href=./minimal-docker-networks>other post</a>.</p><p>Don&rsquo;t forget to apply changes: <code>$ sudo systemctl restart docker.service</code></p><h2 id=docker-housekeeping class=paragraph-header>Docker Housekeeping <a href=#docker-housekeeping></a></h2><p>/etc/crontab:</p><pre tabindex=0><code>0    1  * * *	root	apt-get -y update
0    3  * * *   root    /apps/update_all.sh
0    5  * * *   root    docker system prune --force
*/3  *  * * *   root    /apps/restart_unhealthy.sh
</code></pre><p>Cronjob commands in detail:</p><h4 id=1-apt-get--y-update class=paragraph-header>1. <code>apt-get -y update</code> <a href=#1-apt-get--y-update></a></h4><p>Will install safe package updates.</p><blockquote><p class=warning>Be aware that upgrades (<code>apt-get upgrade</code>) must be still done manually from time to time.</p></blockquote><h4 id=2-appsupdate_allsh class=paragraph-header>2. <code>/apps/update_all.sh</code> <a href=#2-appsupdate_allsh></a></h4><p>Update all container images (might not be desired):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#ff79c6>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>cd</span> /apps
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>for</span> d in */; <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>cd</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$d</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$d</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>    docker compose pull  <span style=color:#6272a4># pull new images</span>
</span></span><span style=display:flex><span>    docker compose build --pull  <span style=color:#6272a4># pull new base images and build new images</span>
</span></span><span style=display:flex><span>    docker compose up -d --remove-orphans  <span style=color:#6272a4># start new containers from new images</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>cd</span> ..
</span></span><span style=display:flex><span><span style=color:#ff79c6>done</span>
</span></span></code></pre></div><h4 id=3-docker-system-prune---force class=paragraph-header>3. <code>docker system prune --force</code> <a href=#3-docker-system-prune---force></a></h4><p>Free disk space by cleaning up old docker entities, mostly stopped containers and images.</p><blockquote><p class=warning><code>docker system prune --force</code> might take some time. do not run container updates meanwhile as it could confuse docker (problems with port allocations)</p></blockquote><h4 id=4-appsrestart_unhealthysh class=paragraph-header>4. <code>/apps/restart_unhealthy.sh</code> <a href=#4-appsrestart_unhealthysh></a></h4><p>Docker detects failing health checks but will happily ignore them. Docker Swarm (or Kubernetes) on the other hand will restart unhealthy containers. That missing feature can be corrected with an
<a href=https://github.com/willfarrell/docker-autoheal target=_blank rel="noopener noreferrer">extra container</a> or a really simple script:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#ff79c6>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#ff79c6></span>docker ps --filter <span style=color:#8be9fd;font-style:italic>health</span><span style=color:#ff79c6>=</span>unhealthy --format <span style=color:#f1fa8c>&#34;docker restart {{.ID}}&#34;</span> | bash
</span></span></code></pre></div><h2 id=general-advice class=paragraph-header>General advice <a href=#general-advice></a></h2><ul><li>Add a <code>mem_limit</code> for every container, don&rsquo;t forget it!</li><li>If a container has no need to connect to the world (internet or local network) then make all attached Docker Networks &ldquo;internal&rdquo;.</li><li>If addressing a container in the network via it&rsquo;s name fails then set the <code>hostname</code> explicitly.</li><li>If volumes map to directories on the host (bind mounts) then create the folders before starting the containers. Otherwise docker will create the folders as user root which often causes permission problems.</li></ul><div class=comments><a href="https://github.com/knrdl/knrdl.github.io/issues/new?title=Minimal+setup+for+a+docker+host" target=_blank rel="noopener noreferrer"><img src=https://knrdl.github.io/github.png alt="Github logo" style=filter:invert(.7) width=17 height=17>
<span>Feedback</span></a></div></article></main><hr><footer>Licensed under <a href=https://creativecommons.org/publicdomain/zero/1.0/ target=_blank rel='noopener norefferer'>CC0 1.0</a> |
<a href=https://gohugo.io target=_blank rel='noopener norefferer'>Hugo</a> theme inspired by <a href=https://github.com/vamc19 target=_blank rel='noopener norefferer'>vamc19</a> |
Hosted by <a href=https://pages.github.com target=_blank rel='noopener norefferer'>Github</a> (<a href=https://github.com/site/privacy target=_blank rel='noopener norefferer'>Privacy Policy</a>)</footer></body></html>