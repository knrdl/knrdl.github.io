<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta http-equiv=Content-Security-Policy content="default-src 'none'; style-src 'self' 'unsafe-inline'; img-src 'self' https:; font-src 'self'; script-src 'unsafe-inline'"><link rel="shortcut icon" type=image/png href=/favicon.png><link rel=sitemap type=application/xml href=/sitemap.xml title=knrdlog><title>Scan all Docker images on a host for vulnerabilities</title><meta name=description content="notes to self"><meta property="og:url" content="https://knrdl.github.io/posts/docker-trivy-scan/"><meta property="og:site_name" content="knrdlog"><meta property="og:title" content="Scan all Docker images on a host for vulnerabilities"><meta property="og:description" content='Aquasec Trivy is an open-source vulnerability scanner for dependencies. It can be used to get a quick overview of all (tagged) Docker images on a host and their respective vulnerabilities. This can be done with the following Compose setup:
services: secscan-reports: image: caddy:alpine command: caddy file-server --root /reports --browse --listen :8080 volumes: - ./reports:/reports:ro ports: - 127.0.0.1:8080:8080 # exposed at http://localhost:8080/?sort=time&amp;order=desc trivy: image: aquasec/trivy environment: DOCKER_HOST: tcp://docker-socket-protector:2375 entrypoint: [ "/bin/sh", "-c" ] command: - | sleep 10m apk add docker-cli jq while true; do for imagename in $(docker ps -a --format="{{.Image}}" | uniq); do echo "Scanning image: $$imagename" filename=$(echo -n "$$imagename" | jq -sRr &#39;@uri&#39;) rm "/reports/$$filename.html" nice -n 19 trivy image --no-progress --scanners vuln,secret,misconfig --severity MEDIUM,HIGH,CRITICAL --format template --template "@contrib/html.tpl" -o "/reports/$$filename.html" "$$imagename" done sleep 24h done volumes: - ./reports:/reports cpus: 0.1 depends_on: - docker-socket-protector networks: - internet - docker_socket docker-socket-protector: image: knrdl/docker-socket-protector hostname: docker-socket-protector restart: always read_only: true cap_drop: [ all ] environment: PROFILE: "trivy" # read only access to only docker images LOG_REQUESTS: "false" volumes: - /var/run/docker.sock:/var/run/docker.sock networks: - docker_socket mem_limit: 100mb networks: internet: internal: false docker_socket: internal: true attachable: false'><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-04-01T00:00:00+00:00"><meta property="article:modified_time" content="2024-04-01T17:38:33+02:00"><meta property="article:tag" content="Docker"><meta property="article:tag" content="Trivy"><meta name=author content="knrdl"><link rel=stylesheet href=https://knrdl.github.io/styles.min.b1eb305989f01c7be31a7a19d4ab34ca470eddd06327253c7bcf3d1c5a41d28c.css integrity="sha256-seswWYnwHHvjGnoZ1Ks0ykcO3dBjJyU8e889HFpB0ow="></head><body><header><div class=site-header><span><a href=https://knrdl.github.io/ class=site-title>knrdlog</a>
</span><span><nav class=right-menu><span class=menu-item><a href=/tags/>tags</a></span>
<span class=menu-item><a href=https://github.com/knrdl target=_blank rel="noopener noreferrer">github</a></span>
<span class=menu-item><a href=/index.xml>rss</a></span></nav></span></div><div class=separator>================================================================================================================================================================</div></header><main><article><div class=post-header><h1>Scan all Docker images on a host for vulnerabilities</h1><time datetime=2024-04-01 class=pubdate>2024-04-01</time>
<span class=tags><a href=/tags/docker class=hashtag>docker</a>
<a href=/tags/trivy class=hashtag>trivy</a></span></div><p>Aquasec Trivy is an open-source vulnerability scanner for dependencies. It can be used to get a quick overview of all (tagged) Docker images on a host and their respective vulnerabilities. This can be done with the following Compose setup:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>secscan-reports</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>image</span>: caddy:alpine
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>command</span>: caddy file-server --root /reports --browse --listen :8080
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>volumes</span>:
</span></span><span style=display:flex><span>      - ./reports:/reports:ro
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#bd93f9>127.0.0.1</span>:<span style=color:#bd93f9>8080</span>:<span style=color:#bd93f9>8080</span>  <span style=color:#6272a4># exposed at http://localhost:8080/?sort=time&amp;order=desc</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>trivy</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>image</span>: aquasec/trivy
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>environment</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>DOCKER_HOST</span>: tcp://docker-socket-protector:2375
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>entrypoint</span>: [ <span style=color:#f1fa8c>&#34;/bin/sh&#34;</span>, <span style=color:#f1fa8c>&#34;-c&#34;</span> ]
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>command</span>:
</span></span><span style=display:flex><span>      - |<span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        sleep 10m
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        apk add docker-cli jq
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        while true; do
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>          for imagename in $(docker ps -a --format=&#34;{{.Image}}&#34; | uniq); do 
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            echo &#34;Scanning image: $$imagename&#34;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            filename=$(echo -n &#34;$$imagename&#34; | jq -sRr &#39;@uri&#39;)
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            rm &#34;/reports/$$filename.html&#34;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            nice -n 19 trivy image --no-progress --scanners vuln,secret,misconfig --severity MEDIUM,HIGH,CRITICAL --format template --template &#34;@contrib/html.tpl&#34; -o &#34;/reports/$$filename.html&#34; &#34;$$imagename&#34;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>          done
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>          sleep 24h
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        done</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>volumes</span>:
</span></span><span style=display:flex><span>      - ./reports:/reports
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>cpus</span>: <span style=color:#bd93f9>0.1</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>depends_on</span>:
</span></span><span style=display:flex><span>      - docker-socket-protector
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>networks</span>:
</span></span><span style=display:flex><span>      - internet
</span></span><span style=display:flex><span>      - docker_socket
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>docker-socket-protector</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>image</span>: knrdl/docker-socket-protector
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>hostname</span>: docker-socket-protector
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>restart</span>: always
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>read_only</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>cap_drop</span>: [ all ]
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>environment</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>PROFILE</span>: <span style=color:#f1fa8c>&#34;trivy&#34;</span>  <span style=color:#6272a4># read only access to only docker images</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>LOG_REQUESTS</span>: <span style=color:#f1fa8c>&#34;false&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>volumes</span>:
</span></span><span style=display:flex><span>      - /var/run/docker.sock:/var/run/docker.sock
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>networks</span>:
</span></span><span style=display:flex><span>      - docker_socket
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>mem_limit</span>: 100mb
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>networks</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>internet</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>internal</span>: <span style=color:#ff79c6>false</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>docker_socket</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>internal</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>attachable</span>: <span style=color:#ff79c6>false</span>
</span></span></code></pre></div><div class=comments><a href="https://github.com/knrdl/knrdl.github.io/issues/new?title=Scan+all+Docker+images+on+a+host+for+vulnerabilities" target=_blank rel="noopener noreferrer"><img src=https://knrdl.github.io/github.png alt="Github logo" style=filter:invert(.7) width=17 height=17>
<span>Feedback</span></a></div></article></main><hr><footer>Licensed under <a href=https://creativecommons.org/publicdomain/zero/1.0/ target=_blank rel='noopener norefferer'>CC0 1.0</a> |
<a href=https://gohugo.io target=_blank rel='noopener norefferer'>Hugo</a> theme inspired by <a href=https://github.com/vamc19 target=_blank rel='noopener norefferer'>vamc19</a> |
Hosted by <a href=https://pages.github.com target=_blank rel='noopener norefferer'>Github</a> (<a href=https://github.com/site/privacy target=_blank rel='noopener norefferer'>Privacy Policy</a>)</footer></body></html>