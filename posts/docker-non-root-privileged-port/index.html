<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta http-equiv=content-security-policy content="default-src 'none'; style-src 'self' 'unsafe-inline'; img-src 'self'; font-src 'self'"><link rel="shortcut icon" type=image/png href=/favicon.png><link rel=sitemap type=application/xml href=/sitemap.xml title=knrdlog><title>Bind non-root process to privileged port inside a Docker container</title><meta name=description content="notes to self"><meta property="og:title" content="Bind non-root process to privileged port inside a Docker container"><meta property="og:description" content="The Principle of Least Privilege (PoLP) should also be applied to applications inside a container! Running stuff as root user is never a good idea. A custom user profile with fewer privileges should be created and used instead.
But such a user cannot bind a privileged port (<1024), e.g. start a webserver on port 80. Exposure via port binding to the host is still unproblematic, e.g. docker run -p 80:8080 ."><meta property="og:type" content="article"><meta property="og:url" content="https://knrdl.github.io/posts/docker-non-root-privileged-port/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-06-15T00:00:00+00:00"><meta property="article:modified_time" content="2022-06-15T15:47:24+02:00"><meta name=author content="knrdl"><link rel=stylesheet href=https://knrdl.github.io/style.min.cdba56427d6a57db72b02e9432b59f0542b599b6f93cd29ba0b1a5b1bccfa812.css integrity="sha256-zbpWQn1qV9tysC6UMrWfBUK1mbb5PNKboLGlsbzPqBI="></head><body><header><div class=site-header><span><a href=https://knrdl.github.io/ class=site-title>knrdlog</a></span>
<span><nav class=right-menu><span class=menu-item>/<a href=https://github.com/knrdl target=_blank rel="noopener noreferrer">github</a></span>
<span class=menu-item>/<a href=/index.xml target=_blank rel="noopener noreferrer">rss</a></span></nav></span></div><div class=separator>================================================================================================================================================================</div></header><main><article><div class=post-header><h1>Bind non-root process to privileged port inside a Docker container</h1><span class=pubdate>2022-06-15</span>
<span class=tags><a href=/tags/docker class=hashtag>docker</a>
<a href=/tags/linux class=hashtag>linux</a></span></div><p>The Principle of Least Privilege (PoLP) should also be applied to applications inside a container! Running stuff as root
user is never a good idea. A custom user profile with fewer privileges should be created and used instead.</p><p>But such a user cannot bind a privileged port (&lt;1024), e.g. start a webserver on port 80. Exposure via port binding to
the host is still unproblematic, e.g. <code>docker run -p 80:8080 ...</code> will bind port 8080 of the container to port 80 on the
host.</p><p>But what if two services share a Docker Network to reach each other? Then requests have to be made to
e.g. <strong>http://service2:8080/api</strong> (includes the port 8080). This is a bit ugly because <strong>service1</strong> now needs to contain
runtime information about <strong>service2</strong> (contradicts goal of loose coupling). An endpoint like <strong>http://service2/api</strong> (defaults to port 80) is preferable.</p><p>The following Dockerfile achieves that goal:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#ff79c6>FROM</span><span style=color:#f1fa8c> python:3-alpine</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># allow non privileged user to run server on port 80</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>RUN</span> apk add --no-cache libcap <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    setcap <span style=color:#f1fa8c>&#39;cap_net_bind_service=+ep&#39;</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span>readlink -f <span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span>which python3<span style=color:#ff79c6>)</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>)</span><span style=color:#f1fa8c>&#34;</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    apk del libcap
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#ff79c6>EXPOSE</span><span style=color:#f1fa8c> 80/tcp</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>RUN</span> adduser --home /home/appname --disabled-password --shell /bin/false --uid <span style=color:#bd93f9>1000</span> appname
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># all commands after the USER-command will be executed as user `appname`</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>USER</span><span style=color:#f1fa8c> appname</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>RUN</span> whoami
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># now the app can run on port 80 as non root user</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>CMD</span> python3 myapp.py
</span></span></code></pre></div><p>The program <code>setcap</code> is used to give the executable (e.g. <code>/usr/bin/python3</code> or <code>/bin/myapp</code>) the necessary capability (permission). It&rsquo;s not needed afterwards, so it might be deleted to keep the image small.</p><blockquote><p class=info>If you work with <abbr title="Advanced Packaging Tool">APT</abbr> (Ubuntu/Debian images) just use the
package <code>libcap2-bin</code> instead of <code>libcap</code>.</p></blockquote><div class=comments><a href="https://github.com/knrdl/knrdl.github.io/issues/new?title=Bind+non-root+process+to+privileged+port+inside+a+Docker+container" target=_blank rel="noopener noreferrer"><img src=https://knrdl.github.io/github.png alt="Github logo" style=filter:invert(.7) width=17 height=17>
<span>Feedback</span></a></div></article></main><hr><footer>Licensed under <a href=https://creativecommons.org/publicdomain/zero/1.0/ target=_blank rel='noopener norefferer'>CC0 1.0</a> |
<a href=https://gohugo.io target=_blank rel='noopener norefferer'>Hugo</a> theme by <a href=https://github.com/vamc19 target=_blank rel='noopener norefferer'>vamc19</a> |
Hosted by <a href=https://pages.github.com target=_blank rel='noopener norefferer'>Github</a> (<a href=https://github.com/site/privacy target=_blank rel='noopener norefferer'>Privacy Policy</a>)</footer></body></html>