<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Ssh on knrdlog</title><link>https://knrdl.github.io/tags/ssh/</link><description>Recent content in Ssh on knrdlog</description><language>en-us</language><copyright>Licensed under &lt;a href='https://creativecommons.org/publicdomain/zero/1.0/' target='_blank' rel='noopener norefferer'&gt;CC0 1.0&lt;/a&gt; |
&lt;a href="https://gohugo.io" target='_blank' rel='noopener norefferer'&gt;Hugo&lt;/a&gt; theme inspired by &lt;a href="https://github.com/vamc19" target='_blank' rel='noopener norefferer'&gt;vamc19&lt;/a&gt; |
Hosted by &lt;a href="https://pages.github.com" target='_blank' rel='noopener norefferer'&gt;Github&lt;/a&gt; (&lt;a href="https://github.com/site/privacy" target='_blank' rel='noopener norefferer'&gt;Privacy Policy&lt;/a&gt;)</copyright><lastBuildDate>Fri, 20 Dec 2024 00:00:00 +0000</lastBuildDate><atom:link href="https://knrdl.github.io/tags/ssh/index.xml" rel="self" type="application/rss+xml"/><item><title>PinePhone as edge server in a remote network</title><link>https://knrdl.github.io/posts/pinephone-edge-server/</link><pubDate>Fri, 20 Dec 2024 00:00:00 +0000</pubDate><guid>https://knrdl.github.io/posts/pinephone-edge-server/</guid><description>&lt;p&gt;The straight forward way to access a remote network is to setup a VPN connection with the router. If that&amp;rsquo;s not possible, a separate device is required to act as VPN client. A smartphone is particularly suitable for this as it is always on, small, has a low power consumption and makes it easy to configure a wifi connection with the network. The PinePhone is especially suitable for the job as it can host a standard Linux environment which is not messed up like Android. On the PinePhone we need very few tools to work in the remote network:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;Wireguard&lt;/strong&gt; for the VPN tunnel&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;SSH&lt;/strong&gt; server&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Docker&lt;/strong&gt; runtime, e.g. to run a time series database to collect sensor stats&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id="setup" class="paragraph-header"&gt;Setup &lt;a
href="#setup"&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;flash PostmarketOS to a microSD card&lt;/li&gt;
&lt;li&gt;run the wizard on the phone (to resize the root partition)&lt;/li&gt;
&lt;li&gt;copy the PostmarketOS img-file to the microSD card&lt;/li&gt;
&lt;li&gt;flash the img-file to the eMMC via &lt;code&gt;dd&lt;/code&gt;:
&lt;a href="https://pine64.org/documentation/PinePhone/Installation/Installation_to_the_eMMC/#from-the-booted-microsd-os" target="_blank" rel="noopener noreferrer"&gt;https://pine64.org/documentation/PinePhone/Installation/Installation_to_the_eMMC/#from-the-booted-microsd-os&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;remove the sd card and reboot&lt;/li&gt;
&lt;li&gt;login (user:147147) and connect wifi&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id="ssh" class="paragraph-header"&gt;SSH &lt;a
href="#ssh"&gt;&lt;/a&gt;&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;start ssh server: &lt;code&gt;sudo service sshd start&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;enable ssh on boot: &lt;code&gt;sudo rc-update add sshd&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;connect to the phone: &lt;code&gt;ssh user@pine64-pinephone&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;in &lt;code&gt;/etc/ssh/sshd_config&lt;/code&gt;: set &lt;code&gt;AllowTcpForwarding yes&lt;/code&gt; to forward ports from the remote network to your local host&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id="system" class="paragraph-header"&gt;System &lt;a
href="#system"&gt;&lt;/a&gt;&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;check updates: &lt;code&gt;sudo apk update&lt;/code&gt; and &lt;code&gt;sudo apk upgrade -a&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;install some tools: &lt;code&gt;sudo apk add htop curl nano&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;remove unnecessary apps: &lt;code&gt;sudo apk del gnome-maps gnome-calculator gnome-software gnome-clocks gnome-calendar gnome-text-editor gnome-contacts gnome-weather chatty portfolio lollypop firefox-esr evince calls megapixels postmarketos-default-camera postmarketos-welcome loupe flatpak&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;list remaining packages: &lt;code&gt;sudo apk list -I&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;disable unnecessary services: &lt;code&gt;sudo rc-update del bluetooth&lt;/code&gt; and &lt;code&gt;sudo rc-update del modemmanager&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;list enabled services: &lt;code&gt;sudo rc-update show&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id="wireguard" class="paragraph-header"&gt;Wireguard &lt;a
href="#wireguard"&gt;&lt;/a&gt;&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;install: &lt;code&gt;sudo apk add wireguard-tools-wg-quick wireguard-tools-openrc&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;add wireguard config to &lt;code&gt;/etc/wireguard/wg0.conf&lt;/code&gt;, e.g.:&lt;/li&gt;
&lt;/ol&gt;
&lt;pre tabindex="0"&gt;&lt;code class="language-conf" data-lang="conf"&gt;[Interface]
PrivateKey = XXXXXXXXXXXXXXXXXXXXXXXXXXXXX
Address = 192.168.178.204/24
DNS = 192.168.178.1
DNS = fritz.box
[Peer]
PublicKey = XXXXXXXXXXXXXXXXXXXXXXXXXXXXX
PresharedKey = XXXXXXXXXXXXXXXXXXXXXXXXXXXXX
AllowedIPs = 192.168.178.0/24,0.0.0.0/0
Endpoint = XXXXXXXXXXXXXXXXXXXXXXXXXXXXX.myfritz.net:12345
PersistentKeepalive = 25
&lt;/code&gt;&lt;/pre&gt;&lt;ol start="3"&gt;
&lt;li&gt;fix permissions: &lt;code&gt;sudo chmod o-r /etc/wireguard/wg0.conf&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;
&lt;a href="https://wiki.alpinelinux.org/wiki/Configure_a_Wireguard_interface_%28wg%29" target="_blank" rel="noopener noreferrer"&gt;autostart&lt;/a&gt;:&lt;/li&gt;
&lt;/ol&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;sudo ln -s /etc/init.d/wg-quick /etc/init.d/wg-quick.wg0
sudo rc-update add wg-quick.wg0
sudo service wg-quick.wg0 start
&lt;/code&gt;&lt;/pre&gt;&lt;ol start="5"&gt;
&lt;li&gt;manual start: &lt;code&gt;sudo wg-quick up wg0&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;manual stop: &lt;code&gt;sudo wg-quick down wg0&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id="docker" class="paragraph-header"&gt;Docker &lt;a
href="#docker"&gt;&lt;/a&gt;&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;install: &lt;code&gt;sudo apk add docker&lt;/code&gt; (alpine sources typically provide an up-to-date version)&lt;/li&gt;
&lt;li&gt;autostart: &lt;code&gt;sudo rc-update add docker&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;start: &lt;code&gt;sudo service docker start&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;the PinePhone can execute arm32v7 and also arm64v8 images&lt;/li&gt;
&lt;/ol&gt;</description></item><item><title>SSH Tunneling</title><link>https://knrdl.github.io/posts/ssh-tunneling/</link><pubDate>Wed, 13 Apr 2022 00:00:00 +0000</pubDate><guid>https://knrdl.github.io/posts/ssh-tunneling/</guid><description>&lt;p&gt;SSH allows tcp port forwarding between ssh client and ssh server as part of the encrypted ssh connection.&lt;/p&gt;
&lt;h2 id="server--client-local" class="paragraph-header"&gt;Server → Client (local) &lt;a
href="#server--client-local"&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;A socket on the server (source) gets forwarded to the client (target).&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;ssh user@host -L target_ip:target_port:source_ip:source_port
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="use-case-1-admin-software" class="paragraph-header"&gt;Use case 1: Admin software &lt;a
href="#use-case-1-admin-software"&gt;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Server socket with port 9000 will be available on client machine at port 5000.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;ssh user@host -L 127.0.0.1:5000:127.0.0.1:9000
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Useful if admin software is only accessible on the server (localhost binding) and not exposed to the network.&lt;/p&gt;
&lt;h3 id="use-case-2-quick-demo" class="paragraph-header"&gt;Use Case 2: Quick demo &lt;a
href="#use-case-2-quick-demo"&gt;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Server socket with port 9000 will be accessible at client network on port 8080 of the client machine.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;ssh user@host -L 8080:127.0.0.1:9000
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;ssh user@host -L 0.0.0.0:8080:127.0.0.1:9000
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Useful for a quick demo of a service running in a different network (e.g. cloud) to multiple participants in the same
network (e.g. company).&lt;/p&gt;
&lt;h3 id="use-case-3-jump-host" class="paragraph-header"&gt;Use case 3: Jump Host &lt;a
href="#use-case-3-jump-host"&gt;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Server can reach host with ip addr 192.168.1.15. Service on 192.168.1.15:8080 will be available on client machine at
port 8081.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;ssh user@host -L 127.0.0.1:8081:192.168.1.15:8080
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Hop to hop forwarding of hosts accessible in the server network(s).&lt;/p&gt;
&lt;h2 id="client--server-remote" class="paragraph-header"&gt;Client → Server (remote) &lt;a
href="#client--server-remote"&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;A socket on the client (source) gets forwarded to the server (target).&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;ssh user@host -R target_port:source_ip:source_port
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="use-case-1-microservice-development" class="paragraph-header"&gt;Use case 1: Microservice development &lt;a
href="#use-case-1-microservice-development"&gt;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Service on port 8000 of the client machine will be available on server at port 8081. Unless &lt;code&gt;GatewayPorts&lt;/code&gt; is set
to &lt;code&gt;yes&lt;/code&gt; in sshd config (default &lt;code&gt;no&lt;/code&gt;) the serverside bind will always be localhost (127.0.0.1).&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;ssh user@host -R 8081:127.0.0.1:8000
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Useful to integrate a microservice on developer machine into a foreign environment (e.g. test cluster). Also works with
other source addresses than &lt;code&gt;127.0.0.1&lt;/code&gt;.&lt;/p&gt;
&lt;h3 id="use-case-2-tls-terminating-web-proxy-as-a-service" class="paragraph-header"&gt;Use case 2: TLS terminating web proxy as a service &lt;a
href="#use-case-2-tls-terminating-web-proxy-as-a-service"&gt;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Client starts a http server on local machine on port 8000. That service will be available as
&lt;a href="https://server.tld" target="_blank" rel="noopener noreferrer"&gt;https://server.tld&lt;/a&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;ssh user@host -R 8001:127.0.0.1:8000
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Processing order:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Webbrowser (User Agent) requests
&lt;a href="https://server.tld" target="_blank" rel="noopener noreferrer"&gt;https://server.tld&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Reaches a reverse proxy on port 443
&lt;ul&gt;
&lt;li&gt;does tls termination&lt;/li&gt;
&lt;li&gt;and proxying, nginx: &lt;code&gt;proxy_pass 127.0.0.1:8001;&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;SSH Tunnel&lt;/li&gt;
&lt;li&gt;local machine port 8000 http server&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id="ssh-config" class="paragraph-header"&gt;SSH Config &lt;a
href="#ssh-config"&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;port forwarding can also be specified on the client in &lt;code&gt;~/.ssh/config&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"&gt;&lt;code class="language-text" data-lang="text"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;Host server-01
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; HostName 192.168.1.2
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; Port 22
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; User clusteradm
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex; background-color:#3d3f4a"&gt;&lt;span&gt; LocalForward localhost:9001 localhost:9000
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex; background-color:#3d3f4a"&gt;&lt;span&gt; RemoteForward 8001 localhost:8000
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; KeepAlive yes
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; IdentitiesOnly yes
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; IdentityFile ~/.ssh/server_01_clusteradm
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Config format is &lt;code&gt;(Local|Remote)Forward target source&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;connect via &lt;code&gt;$ ssh server-01&lt;/code&gt;&lt;/p&gt;
&lt;h2 id="persistent-connections" class="paragraph-header"&gt;Persistent connections &lt;a
href="#persistent-connections"&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Just use the &lt;code&gt;autossh&lt;/code&gt; command in place of &lt;code&gt;ssh&lt;/code&gt;. AutoSSH uses heartbeats to check if the connection is still open and
open another one otherwise automatically and fully transparent.&lt;/p&gt;
&lt;h2 id="dedicated-tunneling-server" class="paragraph-header"&gt;Dedicated tunneling server &lt;a
href="#dedicated-tunneling-server"&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;It&amp;rsquo;s possible to run a standalone ssh server which just allows port forwarding and no remote command execution. Setup:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;mkdir -p /jail
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;adduser --gecos &lt;span style="color:#f1fa8c"&gt;&amp;#34;&amp;#34;&lt;/span&gt; --no-create-home --shell /bin/false --disabled-password --uid &lt;span style="color:#bd93f9"&gt;1000&lt;/span&gt; sshtunnel
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Excerpt from &lt;code&gt;/etc/ssh/sshd_config&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#6272a4"&gt;# AllowUsers list all users which should be able to login&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;AllowUsers sshtunnel
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;Match User sshtunnel
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; PermitTTY no
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; Banner none
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; X11Forwarding no
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; AllowAgentForwarding no
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#6272a4"&gt;# AllowTcpForwarding: yes (= local+remote), local, remote, no&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; AllowTcpForwarding &lt;span style="color:#8be9fd;font-style:italic"&gt;local&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; GatewayPorts no
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; PermitTunnel no
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; ChrootDirectory /jail
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; ForceCommand /bin/false
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; PermitOpen 127.0.0.1:8730
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Start sshd in foreground: &lt;code&gt;$ sshd -D -e&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;Connect client: &lt;code&gt;$ ssh -N -L 127.0.0.1:8730:127.0.0.1:8730 sshtunnel@localhost&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;Flag &lt;code&gt;-N&lt;/code&gt; prevents the spawning of a shell (which would result in a connection abortion otherwise).&lt;/p&gt;
&lt;h2 id="rsync-tunneling-also-sftp" class="paragraph-header"&gt;Rsync tunneling (also sftp) &lt;a
href="#rsync-tunneling-also-sftp"&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;rsync&lt;/code&gt; can copy (sync) files between hosts. Therefore, it can use ssh as a transfer protocol. But that implies running
the rsync command on the server:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;rsync -av -e ssh user@host:/backup/ /datadir/
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;That won&amp;rsquo;t work with a tunneling only ssh server. Luckily rsync can also be operated with a standalone server, so the
rsync protocol can be tunneled via ssh.&lt;/p&gt;
&lt;h3 id="server-setup" class="paragraph-header"&gt;Server Setup &lt;a
href="#server-setup"&gt;&lt;/a&gt;&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;adduser --gecos &lt;span style="color:#f1fa8c"&gt;&amp;#34;&amp;#34;&lt;/span&gt; --no-create-home --shell /bin/false --disabled-password --uid &lt;span style="color:#bd93f9"&gt;1001&lt;/span&gt; rsyncbackup
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;sudo mkdir -p /jail/backup
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;sudo chown -R root:root /jail &lt;span style="color:#6272a4"&gt;# user cannot have write permission to chroot dir&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;sudo chown -R rsyncbackup:rsyncbackup /jail/backup
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;sudo chmod -R &lt;span style="color:#bd93f9"&gt;755&lt;/span&gt; /jail/backup
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Excerpt from &lt;code&gt;/etc/ssh/sshd_config&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#6272a4"&gt;# allow sftp connections&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;Subsystem sftp internal-sftp
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#6272a4"&gt;# AllowUsers list all users which should be able to login&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;AllowUsers rsyncbackup
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;Match User rsyncbackup
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; PermitTTY no
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; Banner none
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; X11Forwarding no
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; AllowAgentForwarding no
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#6272a4"&gt;# AllowTcpForwarding: yes (= local+remote), local, remote, no&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; AllowTcpForwarding &lt;span style="color:#8be9fd;font-style:italic"&gt;local&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; GatewayPorts no
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; PermitTunnel no
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; ChrootDirectory /jail
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; ForceCommand internal-sftp
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; PermitOpen 127.0.0.1:8730
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;In addition to rsync this config also allows file browsing via sftp in the &lt;code&gt;/jail&lt;/code&gt; dir.&lt;/p&gt;
&lt;p&gt;Rsync server config in &lt;code&gt;/etc/rsyncd.conf&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;use &lt;span style="color:#8be9fd;font-style:italic"&gt;chroot&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;=&lt;/span&gt; &lt;span style="color:#8be9fd;font-style:italic"&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;hosts &lt;span style="color:#8be9fd;font-style:italic"&gt;allow&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;=&lt;/span&gt; 127.0.0.1/32
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8be9fd;font-style:italic"&gt;port&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;=&lt;/span&gt; &lt;span style="color:#bd93f9"&gt;8730&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8be9fd;font-style:italic"&gt;timeout&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;=&lt;/span&gt; &lt;span style="color:#bd93f9"&gt;300&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;max &lt;span style="color:#8be9fd;font-style:italic"&gt;connections&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;=&lt;/span&gt; &lt;span style="color:#bd93f9"&gt;2&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;reverse &lt;span style="color:#8be9fd;font-style:italic"&gt;lookup&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;=&lt;/span&gt; no
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;log &lt;span style="color:#8be9fd;font-style:italic"&gt;file&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;=&lt;/span&gt; /dev/stdout
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;log &lt;span style="color:#8be9fd;font-style:italic"&gt;format&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;=&lt;/span&gt; %h %o %f %l %b
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pid &lt;span style="color:#8be9fd;font-style:italic"&gt;file&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;=&lt;/span&gt; /var/run/rsyncd.pid
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#ff79c6"&gt;[&lt;/span&gt;backup_sink&lt;span style="color:#ff79c6"&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8be9fd;font-style:italic"&gt;comment&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;=&lt;/span&gt; Backup
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8be9fd;font-style:italic"&gt;path&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;=&lt;/span&gt; /jail
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8be9fd;font-style:italic"&gt;read&lt;/span&gt; &lt;span style="color:#8be9fd;font-style:italic"&gt;only&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;=&lt;/span&gt; no
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8be9fd;font-style:italic"&gt;list&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;=&lt;/span&gt; yes
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8be9fd;font-style:italic"&gt;uid&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;=&lt;/span&gt; rsyncbackup
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8be9fd;font-style:italic"&gt;gid&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;=&lt;/span&gt; rsyncbackup
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Start rsync server: &lt;code&gt;$ rsync --daemon --config /etc/rsyncd.conf&lt;/code&gt;&lt;/p&gt;
&lt;h3 id="client-setup" class="paragraph-header"&gt;Client Setup &lt;a
href="#client-setup"&gt;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Record in &lt;code&gt;.ssh/config&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; Host backup-conn
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; HostName 192.168.1.32
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; Port &lt;span style="color:#bd93f9"&gt;2201&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; User rsyncbackup
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; KeepAlive yes
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; LocalForward 127.0.0.1:8730 127.0.0.1:8730
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Run a rsync job:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;ssh -N backup-conn &amp;amp; &lt;span style="color:#6272a4"&gt;# no tty possible, either use pubkey-auth or use sshpass to submit the password&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8be9fd;font-style:italic"&gt;pid&lt;/span&gt;&lt;span style="color:#ff79c6"&gt;=&lt;/span&gt;&lt;span style="color:#8be9fd;font-style:italic"&gt;$!&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;sleep &lt;span style="color:#bd93f9"&gt;3&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8be9fd;font-style:italic"&gt;time&lt;/span&gt; rsync bigfile rsync://localhost:8730/backup_sink/backup
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8be9fd;font-style:italic"&gt;kill&lt;/span&gt; &lt;span style="color:#8be9fd;font-style:italic"&gt;$pid&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Check that &lt;code&gt;/jail/backup/bigfile&lt;/code&gt; has been created on the server.&lt;/p&gt;</description></item></channel></rss>