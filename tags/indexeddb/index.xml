<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Indexeddb on knrdlog</title><link>https://knrdl.github.io/tags/indexeddb/</link><description>Recent content in Indexeddb on knrdlog</description><language>en-us</language><copyright>Licensed under &lt;a href='https://creativecommons.org/publicdomain/zero/1.0/' target='_blank' rel='noopener norefferer'&gt;CC0 1.0&lt;/a&gt; |
&lt;a href="https://gohugo.io" target='_blank' rel='noopener norefferer'&gt;Hugo&lt;/a&gt; theme inspired by &lt;a href="https://github.com/vamc19" target='_blank' rel='noopener norefferer'&gt;vamc19&lt;/a&gt; |
Hosted by &lt;a href="https://pages.github.com" target='_blank' rel='noopener norefferer'&gt;Github&lt;/a&gt; (&lt;a href="https://github.com/site/privacy" target='_blank' rel='noopener norefferer'&gt;Privacy Policy&lt;/a&gt;)</copyright><lastBuildDate>Fri, 06 Dec 2024 00:00:00 +0000</lastBuildDate><atom:link href="https://knrdl.github.io/tags/indexeddb/index.xml" rel="self" type="application/rss+xml"/><item><title>LocalForage: Performant batch operations</title><link>https://knrdl.github.io/posts/indexeddb-localforage/</link><pubDate>Fri, 06 Dec 2024 00:00:00 +0000</pubDate><guid>https://knrdl.github.io/posts/indexeddb-localforage/</guid><description>&lt;h2 id="problem" class="paragraph-header"&gt;Problem &lt;a
href="#problem"&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;
&lt;a href="https://github.com/localForage/localForage" target="_blank" rel="noopener noreferrer"&gt;LocalForage&lt;/a&gt; is a thin wrapper around
&lt;a href="https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API" target="_blank" rel="noopener noreferrer"&gt;IndexedDB&lt;/a&gt; (and some fallbacks). IndexedDB is a NoSQL database API exposed by modern browsers. It allows storing JSON and blobs client-side. LocalForage simplifies interacting with IndexedDB by providing a simple key-value store as API instead. The method names are
&lt;a href="https://developer.mozilla.org/de/docs/Web/API/Window/localStorage" target="_blank" rel="noopener noreferrer"&gt;localStorage&lt;/a&gt;-like: &lt;code&gt;getItem()&lt;/code&gt;, &lt;code&gt;setItem()&lt;/code&gt;, &lt;code&gt;removeItem()&lt;/code&gt; etc.&lt;/p&gt;
&lt;p&gt;However, batch operations (like a mass insert) are horribly slow when performed via LocalForage. That&amp;rsquo;s because LocalForage opens for every operation a new IndexedDB transaction and this action is remarkable time-consuming compared with other DBMS. So 1000 &lt;code&gt;setItems()&lt;/code&gt; open 1000 transactions which can take multiple seconds to proceed. As LocalForage doesn&amp;rsquo;t provide the API to do this in a single transaction, you need to write your own thin wrapper around IndexedDB and expose transactions as entity.&lt;/p&gt;
&lt;h2 id="solution" class="paragraph-header"&gt;Solution &lt;a
href="#solution"&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-typescript" data-lang="typescript"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#ff79c6"&gt;export&lt;/span&gt; &lt;span style="color:#8be9fd;font-style:italic"&gt;function&lt;/span&gt; kvDb(name: &lt;span style="color:#8be9fd"&gt;string&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;=&lt;/span&gt; &lt;span style="color:#f1fa8c"&gt;&amp;#39;kvdb&amp;#39;&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#8be9fd;font-style:italic"&gt;let&lt;/span&gt; openedDb: &lt;span style="color:#8be9fd"&gt;IDBDatabase&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;|&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;undefined&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#8be9fd;font-style:italic"&gt;function&lt;/span&gt; idbRequestToPromise&amp;lt;&lt;span style="color:#ff79c6"&gt;T&lt;/span&gt;&amp;gt;(request: &lt;span style="color:#8be9fd"&gt;IDBRequest&lt;/span&gt;&amp;lt;&lt;span style="color:#ff79c6"&gt;T&lt;/span&gt;&amp;gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;return&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;new&lt;/span&gt; Promise&amp;lt;&lt;span style="color:#ff79c6"&gt;T&lt;/span&gt;&amp;gt;((resolve, reject) &lt;span style="color:#ff79c6"&gt;=&amp;gt;&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; request.onsuccess &lt;span style="color:#ff79c6"&gt;=&lt;/span&gt; () &lt;span style="color:#ff79c6"&gt;=&amp;gt;&lt;/span&gt; resolve(request.result)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; request.onerror &lt;span style="color:#ff79c6"&gt;=&lt;/span&gt; () &lt;span style="color:#ff79c6"&gt;=&amp;gt;&lt;/span&gt; reject(request.error)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; })
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;async&lt;/span&gt; &lt;span style="color:#8be9fd;font-style:italic"&gt;function&lt;/span&gt; openDb() {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;const&lt;/span&gt; dbRequest &lt;span style="color:#ff79c6"&gt;=&lt;/span&gt; indexedDB.open(name)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; dbRequest.onupgradeneeded &lt;span style="color:#ff79c6"&gt;=&lt;/span&gt; () &lt;span style="color:#ff79c6"&gt;=&amp;gt;&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; dbRequest.result.createObjectStore(&lt;span style="color:#f1fa8c"&gt;&amp;#39;kv-pairs&amp;#39;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;return&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;await&lt;/span&gt; idbRequestToPromise(dbRequest)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;return&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#6272a4"&gt;/**
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#6272a4"&gt; * A transaction is autocommitted as soon as no new requests are made (!)
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#6272a4"&gt; * All requests must be added in the same cycle of the event loop.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#6272a4"&gt; * The transaction cannot be used afterwards.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#6272a4"&gt; */&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;async&lt;/span&gt; transaction() {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;if&lt;/span&gt; (&lt;span style="color:#ff79c6"&gt;!&lt;/span&gt;openedDb) openedDb &lt;span style="color:#ff79c6"&gt;=&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;await&lt;/span&gt; openDb()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;return&lt;/span&gt; openedDb.transaction(&lt;span style="color:#f1fa8c"&gt;&amp;#39;kv-pairs&amp;#39;&lt;/span&gt;, &lt;span style="color:#f1fa8c"&gt;&amp;#39;readwrite&amp;#39;&lt;/span&gt;).objectStore(&lt;span style="color:#f1fa8c"&gt;&amp;#39;kv-pairs&amp;#39;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; },
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;async&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;get&lt;/span&gt;&amp;lt;&lt;span style="color:#ff79c6"&gt;T&lt;/span&gt;&amp;gt;(key: &lt;span style="color:#8be9fd"&gt;string&lt;/span&gt;, transaction?: &lt;span style="color:#8be9fd"&gt;IDBObjectStore&lt;/span&gt;)&lt;span style="color:#ff79c6"&gt;:&lt;/span&gt; Promise&amp;lt;&lt;span style="color:#ff79c6"&gt;T&lt;/span&gt;&amp;gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;const&lt;/span&gt; store &lt;span style="color:#ff79c6"&gt;=&lt;/span&gt; transaction &lt;span style="color:#ff79c6"&gt;??&lt;/span&gt; (&lt;span style="color:#ff79c6"&gt;await&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;this&lt;/span&gt;.transaction())
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;const&lt;/span&gt; value: &lt;span style="color:#8be9fd"&gt;T&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;|&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;undefined&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;=&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;await&lt;/span&gt; idbRequestToPromise(store.&lt;span style="color:#ff79c6"&gt;get&lt;/span&gt;(key))
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;if&lt;/span&gt; (value &lt;span style="color:#ff79c6"&gt;===&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;undefined&lt;/span&gt;) &lt;span style="color:#ff79c6"&gt;throw&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;new&lt;/span&gt; &lt;span style="color:#8be9fd;font-style:italic"&gt;Error&lt;/span&gt;(&lt;span style="color:#f1fa8c"&gt;`db &amp;#34;&lt;/span&gt;&lt;span style="color:#f1fa8c"&gt;${&lt;/span&gt;name&lt;span style="color:#f1fa8c"&gt;}&lt;/span&gt;&lt;span style="color:#f1fa8c"&gt;&amp;#34; key &amp;#34;&lt;/span&gt;&lt;span style="color:#f1fa8c"&gt;${&lt;/span&gt;key&lt;span style="color:#f1fa8c"&gt;}&lt;/span&gt;&lt;span style="color:#f1fa8c"&gt;&amp;#34; not found`&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;else&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;return&lt;/span&gt; value
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; },
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;async&lt;/span&gt; getDefault&amp;lt;&lt;span style="color:#ff79c6"&gt;T&lt;/span&gt;&amp;gt;(key: &lt;span style="color:#8be9fd"&gt;string&lt;/span&gt;, defaultValue: &lt;span style="color:#8be9fd"&gt;T&lt;/span&gt;, transaction?: &lt;span style="color:#8be9fd"&gt;IDBObjectStore&lt;/span&gt;)&lt;span style="color:#ff79c6"&gt;:&lt;/span&gt; Promise&amp;lt;&lt;span style="color:#ff79c6"&gt;T&lt;/span&gt;&amp;gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;const&lt;/span&gt; store &lt;span style="color:#ff79c6"&gt;=&lt;/span&gt; transaction &lt;span style="color:#ff79c6"&gt;??&lt;/span&gt; (&lt;span style="color:#ff79c6"&gt;await&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;this&lt;/span&gt;.transaction())
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;const&lt;/span&gt; value: &lt;span style="color:#8be9fd"&gt;T&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;|&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;undefined&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;=&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;await&lt;/span&gt; idbRequestToPromise(store.&lt;span style="color:#ff79c6"&gt;get&lt;/span&gt;(key))
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;if&lt;/span&gt; (value &lt;span style="color:#ff79c6"&gt;===&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;undefined&lt;/span&gt;) &lt;span style="color:#ff79c6"&gt;return&lt;/span&gt; defaultValue
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;else&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;return&lt;/span&gt; value
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; },
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;async&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;set&lt;/span&gt;&amp;lt;&lt;span style="color:#ff79c6"&gt;T&lt;/span&gt;&amp;gt;(key: &lt;span style="color:#8be9fd"&gt;string&lt;/span&gt;, value: &lt;span style="color:#8be9fd"&gt;T&lt;/span&gt;, transaction?: &lt;span style="color:#8be9fd"&gt;IDBObjectStore&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;const&lt;/span&gt; store &lt;span style="color:#ff79c6"&gt;=&lt;/span&gt; transaction &lt;span style="color:#ff79c6"&gt;??&lt;/span&gt; (&lt;span style="color:#ff79c6"&gt;await&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;this&lt;/span&gt;.transaction())
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;await&lt;/span&gt; idbRequestToPromise(store.put(value, key))
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; },
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;async&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;delete&lt;/span&gt;(key: &lt;span style="color:#8be9fd"&gt;string&lt;/span&gt;, transaction?: &lt;span style="color:#8be9fd"&gt;IDBObjectStore&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;const&lt;/span&gt; store &lt;span style="color:#ff79c6"&gt;=&lt;/span&gt; transaction &lt;span style="color:#ff79c6"&gt;??&lt;/span&gt; (&lt;span style="color:#ff79c6"&gt;await&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;this&lt;/span&gt;.transaction())
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;await&lt;/span&gt; idbRequestToPromise(store.&lt;span style="color:#ff79c6"&gt;delete&lt;/span&gt;(key))
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; },
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;async&lt;/span&gt; clear(transaction?: &lt;span style="color:#8be9fd"&gt;IDBObjectStore&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;const&lt;/span&gt; store &lt;span style="color:#ff79c6"&gt;=&lt;/span&gt; transaction &lt;span style="color:#ff79c6"&gt;??&lt;/span&gt; (&lt;span style="color:#ff79c6"&gt;await&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;this&lt;/span&gt;.transaction())
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;await&lt;/span&gt; idbRequestToPromise(store.clear())
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;As additional optimization the browser can be asked to persist the storage as long as possible:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-typescript" data-lang="typescript"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#ff79c6"&gt;try&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;await&lt;/span&gt; navigator.storage&lt;span style="color:#ff79c6"&gt;?&lt;/span&gt;.persist&lt;span style="color:#ff79c6"&gt;?&lt;/span&gt;.()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;} &lt;span style="color:#ff79c6"&gt;catch&lt;/span&gt; (e) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; console.error(&lt;span style="color:#f1fa8c"&gt;&amp;#39;navigator.storage.persist() failed:&amp;#39;&lt;/span&gt;, e)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="usage-example" class="paragraph-header"&gt;Usage example &lt;a
href="#usage-example"&gt;&lt;/a&gt;&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-typescript" data-lang="typescript"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#ff79c6"&gt;const&lt;/span&gt; localCache &lt;span style="color:#ff79c6"&gt;=&lt;/span&gt; kvDb(&lt;span style="color:#f1fa8c"&gt;&amp;#39;cache&amp;#39;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#6272a4"&gt;// Without transaction (slow on batch):
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#ff79c6"&gt;await&lt;/span&gt; localCache.clear() &lt;span style="color:#6272a4"&gt;// clear cache
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#ff79c6"&gt;await&lt;/span&gt; localCache.&lt;span style="color:#ff79c6"&gt;set&lt;/span&gt;(&lt;span style="color:#f1fa8c"&gt;&amp;#39;object1&amp;#39;&lt;/span&gt;, {hello&lt;span style="color:#ff79c6"&gt;:&lt;/span&gt; &lt;span style="color:#f1fa8c"&gt;&amp;#39;world&amp;#39;&lt;/span&gt;})
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#ff79c6"&gt;await&lt;/span&gt; localCache.&lt;span style="color:#ff79c6"&gt;get&lt;/span&gt;(&lt;span style="color:#f1fa8c"&gt;&amp;#39;object1&amp;#39;&lt;/span&gt;) &lt;span style="color:#6272a4"&gt;// = {hello: &amp;#39;world&amp;#39;}
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#ff79c6"&gt;await&lt;/span&gt; localCache.getDefault(&lt;span style="color:#f1fa8c"&gt;&amp;#39;object2&amp;#39;&lt;/span&gt;, &lt;span style="color:#f1fa8c"&gt;&amp;#39;fallback&amp;#39;&lt;/span&gt;) &lt;span style="color:#6272a4"&gt;// = &amp;#39;fallback&amp;#39;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#ff79c6"&gt;await&lt;/span&gt; localCache.&lt;span style="color:#ff79c6"&gt;delete&lt;/span&gt;(&lt;span style="color:#f1fa8c"&gt;&amp;#39;object1&amp;#39;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#6272a4"&gt;// With transaction (fast on batch):
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#ff79c6"&gt;const&lt;/span&gt; transaction &lt;span style="color:#ff79c6"&gt;=&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;await&lt;/span&gt; localCache.transaction()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#ff79c6"&gt;await&lt;/span&gt; Promise.allSettled(
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#8be9fd;font-style:italic"&gt;Array&lt;/span&gt;.&lt;span style="color:#ff79c6"&gt;from&lt;/span&gt;(&lt;span style="color:#8be9fd;font-style:italic"&gt;Array&lt;/span&gt;(&lt;span style="color:#bd93f9"&gt;1000&lt;/span&gt;).keys()).map(
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;async&lt;/span&gt; i &lt;span style="color:#ff79c6"&gt;=&amp;gt;&lt;/span&gt; localCache.&lt;span style="color:#ff79c6"&gt;set&lt;/span&gt;(&lt;span style="color:#f1fa8c"&gt;`file-&lt;/span&gt;&lt;span style="color:#f1fa8c"&gt;${&lt;/span&gt;i&lt;span style="color:#f1fa8c"&gt;}&lt;/span&gt;&lt;span style="color:#f1fa8c"&gt;`&lt;/span&gt;, &lt;span style="color:#ff79c6"&gt;await&lt;/span&gt; loadFile(i), transaction)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; )
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;strong&gt;Gotchas:&lt;/strong&gt; A transaction can only be used once with
&lt;a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/all" target="_blank" rel="noopener noreferrer"&gt;&lt;code&gt;Promise.all()&lt;/code&gt;&lt;/a&gt; or
&lt;a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/allSettled" target="_blank" rel="noopener noreferrer"&gt;&lt;code&gt;Promise.allSettled()&lt;/code&gt;&lt;/a&gt;. Using the same transaction in multiple consecutive statements is not possible (thanks to the
&lt;a href="https://developer.mozilla.org/en-US/docs/Web/API/IDBTransaction#:~:text=A%20transaction%20alternates%20between%20active%20and%20inactive%20states%20between%20event%20loop%20tasks." target="_blank" rel="noopener noreferrer"&gt;weird IndexedDB design&lt;/a&gt;).&lt;/p&gt;</description></item></channel></rss>