<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Devops on knrdlog</title><link>https://knrdl.github.io/tags/devops/</link><description>Recent content in Devops on knrdlog</description><language>en-us</language><copyright>Licensed under &lt;a href='https://creativecommons.org/publicdomain/zero/1.0/' target='_blank' rel='noopener norefferer'&gt;CC0 1.0&lt;/a&gt; |
&lt;a href="https://gohugo.io" target='_blank' rel='noopener norefferer'&gt;Hugo&lt;/a&gt; theme inspired by &lt;a href="https://github.com/vamc19" target='_blank' rel='noopener norefferer'&gt;vamc19&lt;/a&gt; |
Hosted by &lt;a href="https://pages.github.com" target='_blank' rel='noopener norefferer'&gt;Github&lt;/a&gt; (&lt;a href="https://github.com/site/privacy" target='_blank' rel='noopener norefferer'&gt;Privacy Policy&lt;/a&gt;)</copyright><lastBuildDate>Mon, 30 Oct 2023 00:00:00 +0000</lastBuildDate><atom:link href="https://knrdl.github.io/tags/devops/index.xml" rel="self" type="application/rss+xml"/><item><title>InfluxDB v2: Single Sign On</title><link>https://knrdl.github.io/posts/influxdb2-sso/</link><pubDate>Mon, 30 Oct 2023 00:00:00 +0000</pubDate><guid>https://knrdl.github.io/posts/influxdb2-sso/</guid><description>&lt;p&gt;The &lt;abbr title="Telegraf, InfluxDB, Chronograf, Kapacitor"&gt;TICK&lt;/abbr&gt; stack v1 did not enforce authentication. So SSO for the Chronograf WebUI could be handled easily via the reverse proxy. InfluxDB v2 includes a WebUI on its own and therefore replaces Chronograf. As InfluxDB v2 enforces built-in authentication there must be accounts. But InfluxDB v2 has no &lt;abbr title="Single Sign On"&gt;SSO&lt;/abbr&gt; capabilities. The solution is to create an &amp;ldquo;All Access API Token&amp;rdquo; and inject it via the reverse proxy, e.g. Caddy:&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;monitor.example.org {
reverse_proxy influxdb:8086 {
header_up Authorization &amp;#34;Token YOUR_TOKEN&amp;#34;
}
}
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Now the WebUI does not require built-in authentication anymore and it could be handled by the reverse proxy again.&lt;/p&gt;
&lt;p&gt;The other always working, obvious solution is to just use Grafana instead.&lt;/p&gt;</description></item><item><title>Gitlab: RenovateBot Setup</title><link>https://knrdl.github.io/posts/gitlab-renovatebot-setup/</link><pubDate>Tue, 24 Oct 2023 00:00:00 +0000</pubDate><guid>https://knrdl.github.io/posts/gitlab-renovatebot-setup/</guid><description>&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;Create a gitlab user &amp;ldquo;renovate.bot&amp;rdquo;:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;External User: Yes&lt;/li&gt;
&lt;li&gt;Personal projects limit: 0&lt;/li&gt;
&lt;li&gt;Can create top level groups: No&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Impersonate &amp;ldquo;renovate.bot&amp;rdquo; (or login as this user) and create a &lt;code&gt;Settings&lt;/code&gt; → &lt;code&gt;Access Tokens&lt;/code&gt;:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Expiration: 1 year (place a reminder to renew this!)&lt;/li&gt;
&lt;li&gt;Scopes: api, read_api, read_repository, write_repository, read_registry&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Create a repository &amp;ldquo;renovate.bot&amp;rdquo; and add the user &amp;ldquo;renovate.bot&amp;rdquo; as Maintainer&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Set a pipeline schedule (how often the renovate bot will run), e.g. every day at 5am: &lt;code&gt;0 5 * * *&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;Settings&lt;/code&gt; → &lt;code&gt;CI/CD&lt;/code&gt; → &lt;code&gt;Variables&lt;/code&gt;: add a variable to supply the access token:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Key: &lt;code&gt;RENOVATE_TOKEN&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Value: the access token of the &amp;ldquo;renovate.bot&amp;rdquo; user (step 2)&lt;/li&gt;
&lt;li&gt;Protect and mask the variable&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p class="warning"&gt;Keep in mind that every gitlab user with (at least) Maintainer role in the &amp;ldquo;renovate.bot&amp;rdquo; repository can see the &lt;code&gt;RENOVATE_TOKEN&lt;/code&gt;. For this reason every maintainer can see and do everything the &amp;ldquo;renovate.bot&amp;rdquo; user is capable of.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ol start="6"&gt;
&lt;li&gt;Add these two files to the repo:&lt;/li&gt;
&lt;/ol&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;.gitlab-ci.yml&lt;/code&gt;:&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#ff79c6"&gt;renovate&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;image&lt;/span&gt;: renovatebot/renovate:37-slim
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;variables&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;RENOVATE_LOG_FILE&lt;/span&gt;: renovate-log.ndjson
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;RENOVATE_LOG_FILE_LEVEL&lt;/span&gt;: debug
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;LOG_LEVEL&lt;/span&gt;: info &lt;span style="color:#6272a4"&gt;# console logging should be less verbose than the logfile because pipeline output is kept forever, logfiles can expire&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;RENOVATE_BASE_DIR&lt;/span&gt;: $CI_PROJECT_DIR
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;RENOVATE_ENDPOINT&lt;/span&gt;: $CI_API_V4_URL
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;RENOVATE_PLATFORM&lt;/span&gt;: gitlab
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;RENOVATE_ALLOW_SCRIPTS&lt;/span&gt;: &lt;span style="color:#f1fa8c"&gt;&amp;#39;true&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;RENOVATE_AUTODISCOVER&lt;/span&gt;: &lt;span style="color:#f1fa8c"&gt;&amp;#39;true&amp;#39;&lt;/span&gt; &lt;span style="color:#6272a4"&gt;# all repos where the &amp;#34;renovate.bot&amp;#34; user is (at least) developer are handled&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;RENOVATE_ONBOARDING&lt;/span&gt;: &lt;span style="color:#f1fa8c"&gt;&amp;#39;false&amp;#39;&lt;/span&gt; &lt;span style="color:#6272a4"&gt;# no initial MR required&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;RENOVATE_REPOSITORY_CACHE&lt;/span&gt;: &lt;span style="color:#f1fa8c"&gt;&amp;#39;enabled&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;RENOVATE_REQUIRE_CONFIG&lt;/span&gt;: &lt;span style="color:#f1fa8c"&gt;&amp;#39;optional&amp;#39;&lt;/span&gt; &lt;span style="color:#6272a4"&gt;# the renovate.json file in each handled repo is not required&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;RENOVATE_TOKEN&lt;/span&gt;: &lt;span style="color:#f1fa8c"&gt;&amp;#34;$RENOVATE_TOKEN&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;RENOVATE_PR_HOURLY_LIMIT&lt;/span&gt;: &lt;span style="color:#f1fa8c"&gt;&amp;#39;50&amp;#39;&lt;/span&gt; &lt;span style="color:#6272a4"&gt;# limit the creation of MRs&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;RENOVATE_CONFIG_FILE&lt;/span&gt;: &lt;span style="color:#f1fa8c"&gt;&amp;#39;config.json&amp;#39;&lt;/span&gt; &lt;span style="color:#6272a4"&gt;# path to renovate global config in &amp;#34;renovate.bot&amp;#34; repo&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;NODE_OPTIONS&lt;/span&gt;: --use-openssl-ca
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;SSL_CERT_DIR&lt;/span&gt;: /etc/ssl/certs
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;REQUESTS_CA_BUNDLE&lt;/span&gt;: /etc/ssl/certs/ca-certificates.crt
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;cache&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;key&lt;/span&gt;: ${CI_COMMIT_REF_SLUG}-renovate
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;paths&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - cache
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;script&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - renovate
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;rules&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#ff79c6"&gt;if&lt;/span&gt;: &lt;span style="color:#f1fa8c"&gt;&amp;#39;$CI_PIPELINE_SOURCE == &amp;#34;schedule&amp;#34;&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;artifacts&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;when&lt;/span&gt;: always
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;expire_in&lt;/span&gt;: 1d
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;paths&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#f1fa8c"&gt;&amp;#39;$RENOVATE_LOG_FILE&amp;#39;&lt;/span&gt; &lt;span style="color:#6272a4"&gt;# remove the renovate logfile from each run after one day to reduce disk usage&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;&lt;code&gt;config.json&lt;/code&gt;:&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-json" data-lang="json"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;{
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;&amp;#34;$schema&amp;#34;&lt;/span&gt;: &lt;span style="color:#f1fa8c"&gt;&amp;#34;https://docs.renovatebot.com/renovate-schema.json&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;&amp;#34;packageRules&amp;#34;&lt;/span&gt;: [
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;&amp;#34;matchDatasources&amp;#34;&lt;/span&gt;: [
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f1fa8c"&gt;&amp;#34;docker&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; ],
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;&amp;#34;registryUrls&amp;#34;&lt;/span&gt;: [
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f1fa8c"&gt;&amp;#34;https://docker-registry-mirror.example.org&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; ]
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; },
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;&amp;#34;matchUpdateTypes&amp;#34;&lt;/span&gt;: [
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f1fa8c"&gt;&amp;#34;minor&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f1fa8c"&gt;&amp;#34;patch&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; ],
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;&amp;#34;enabled&amp;#34;&lt;/span&gt;: &lt;span style="color:#ff79c6"&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; },
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;&amp;#34;matchUpdateTypes&amp;#34;&lt;/span&gt;: [
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f1fa8c"&gt;&amp;#34;major&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; ],
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;&amp;#34;enabled&amp;#34;&lt;/span&gt;: &lt;span style="color:#ff79c6"&gt;false&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; ]
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;This will use a docker registry mirror and open MRs for minor and patch updates (no breaking changes). Unless &lt;code&gt;&amp;quot;automerge&amp;quot;: true&lt;/code&gt; is specified, these MRs will stay open for manual intervention.&lt;/p&gt;
&lt;ol start="7"&gt;
&lt;li&gt;
&lt;p&gt;Add the &amp;ldquo;renovate.bot&amp;rdquo; user to your repositories:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;As &lt;strong&gt;Developer&lt;/strong&gt; if the renovate bot should open MRs &lt;em&gt;but not&lt;/em&gt; automerge them&lt;/li&gt;
&lt;li&gt;As &lt;strong&gt;Maintainer&lt;/strong&gt; if the renovate bot should open MRs &lt;em&gt;and&lt;/em&gt; automerge them (on protected branches)&lt;/li&gt;
&lt;li&gt;As &lt;strong&gt;Reporter&lt;/strong&gt; if the renovate bot depends on this repo to do the version checks for another repo (e.g. another repo is based on the docker image in the gitlab docker registry of this repo)&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Trigger a run of the scheduled pipeline to test the setup.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;View all MRs (for your repositories) opened by the renovate bot:
&lt;a href="https://git.example.org/dashboard/merge_requests?scope=all&amp;amp;state=opened&amp;amp;author_username=renovate.bot" target="_blank" rel="noopener noreferrer"&gt;https://git.example.org/dashboard/merge_requests?scope=all&amp;state=opened&amp;author_username=renovate.bot&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;</description></item><item><title>Minimal setup for a docker host</title><link>https://knrdl.github.io/posts/minimal-docker-host-setup/</link><pubDate>Tue, 01 Nov 2022 00:00:00 +0000</pubDate><guid>https://knrdl.github.io/posts/minimal-docker-host-setup/</guid><description>&lt;h2 id="install-docker" class="paragraph-header"&gt;Install docker &lt;a
href="#install-docker"&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Comes with Docker Compose as &lt;code&gt;$ docker compose&lt;/code&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;sudo apt-get update
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;sudo apt-get install ca-certificates curl gnupg lsb-release
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8be9fd;font-style:italic"&gt;echo&lt;/span&gt; &lt;span style="color:#f1fa8c"&gt;&amp;#34;deb [arch=&lt;/span&gt;&lt;span style="color:#ff79c6"&gt;$(&lt;/span&gt;dpkg --print-architecture&lt;span style="color:#ff79c6"&gt;)&lt;/span&gt;&lt;span style="color:#f1fa8c"&gt; signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f1fa8c"&gt; &lt;/span&gt;&lt;span style="color:#ff79c6"&gt;$(&lt;/span&gt;lsb_release -cs&lt;span style="color:#ff79c6"&gt;)&lt;/span&gt;&lt;span style="color:#f1fa8c"&gt; stable&amp;#34;&lt;/span&gt; | sudo tee /etc/apt/sources.list.d/docker.list &amp;gt; /dev/null
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;sudo apt-get update
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;sudo apt-get install docker-ce docker-ce-cli containerd.io docker-compose-plugin
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Check docker is running: &lt;code&gt;$ docker version&lt;/code&gt;&lt;/p&gt;
&lt;h2 id="enable-swap" class="paragraph-header"&gt;Enable swap &lt;a
href="#enable-swap"&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;If not enabled yet&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;fallocate -l 8G /swapfile
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;sudo chmod &lt;span style="color:#bd93f9"&gt;600&lt;/span&gt; /swapfile
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;sudo mkswap /swapfile
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;sudo swapon /swapfile
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;sudo swapon --show
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Add to &lt;code&gt;/etc/fstab&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;/swapfile swap swap defaults &lt;span style="color:#bd93f9"&gt;0&lt;/span&gt; &lt;span style="color:#bd93f9"&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Optional reboot to check if it worked&lt;/p&gt;
&lt;h2 id="enable-fail2ban" class="paragraph-header"&gt;Enable fail2ban &lt;a
href="#enable-fail2ban"&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Necessary if ssh is accessible over the internet&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;sudo apt install fail2ban
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;sudo systemctl &lt;span style="color:#8be9fd;font-style:italic"&gt;enable&lt;/span&gt; --now fail2ban
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Statistics of failed attempts:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;awk &lt;span style="color:#f1fa8c"&gt;&amp;#39;($(NF-1) = /Ban/){print $NF}&amp;#39;&lt;/span&gt; /var/log/fail2ban.log | sort | uniq -c | sort -n
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;try to log in with wrong passwords to check banning is working!&lt;/p&gt;
&lt;h2 id="useful-shortcuts" class="paragraph-header"&gt;Useful shortcuts &lt;a
href="#useful-shortcuts"&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Add to &lt;code&gt;~/.bashrc&lt;/code&gt;:&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;alias dc=&amp;#39;docker compose&amp;#39;
alias dclf=&amp;#39;docker compose logs --follow&amp;#39;
alias dcup=&amp;#39;docker compose up --detach --remove-orphans --build&amp;#39;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Test in new terminal or run &lt;code&gt;source ~/.bashrc&lt;/code&gt;&lt;/p&gt;
&lt;h2 id="docker-hardening" class="paragraph-header"&gt;Docker Hardening &lt;a
href="#docker-hardening"&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Disable inter container communication (ICC) via &lt;code&gt;/etc/docker/daemon.json&lt;/code&gt;, add:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-json" data-lang="json"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;{
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ff79c6"&gt;&amp;#34;icc&amp;#34;&lt;/span&gt;: &lt;span style="color:#ff79c6"&gt;false&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Might also want to justify address pool, see
&lt;a href="./minimal-docker-networks"&gt;other post&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Don&amp;rsquo;t forget to apply changes: &lt;code&gt;$ sudo systemctl restart docker.service&lt;/code&gt;&lt;/p&gt;
&lt;h2 id="docker-housekeeping" class="paragraph-header"&gt;Docker Housekeeping &lt;a
href="#docker-housekeeping"&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;/etc/crontab:&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;0 1 * * * root apt-get -y update
0 3 * * * root /apps/update_all.sh
0 5 * * * root docker system prune --force
*/3 * * * * root /apps/restart_unhealthy.sh
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Cronjob commands in detail:&lt;/p&gt;
&lt;h4 id="1-apt-get--y-update" class="paragraph-header"&gt;1. &lt;code&gt;apt-get -y update&lt;/code&gt; &lt;a
href="#1-apt-get--y-update"&gt;&lt;/a&gt;&lt;/h4&gt;
&lt;p&gt;Will install safe package updates.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p class="warning"&gt;Be aware that upgrades (&lt;code&gt;apt-get upgrade&lt;/code&gt;) must be still done manually from time to time.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id="2-appsupdate_allsh" class="paragraph-header"&gt;2. &lt;code&gt;/apps/update_all.sh&lt;/code&gt; &lt;a
href="#2-appsupdate_allsh"&gt;&lt;/a&gt;&lt;/h4&gt;
&lt;p&gt;Update all container images (might not be desired):&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#ff79c6"&gt;#!/bin/bash
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8be9fd;font-style:italic"&gt;cd&lt;/span&gt; /apps
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#ff79c6"&gt;for&lt;/span&gt; d in */; &lt;span style="color:#ff79c6"&gt;do&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#8be9fd;font-style:italic"&gt;cd&lt;/span&gt; &lt;span style="color:#f1fa8c"&gt;&amp;#34;&lt;/span&gt;&lt;span style="color:#8be9fd;font-style:italic"&gt;$d&lt;/span&gt;&lt;span style="color:#f1fa8c"&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#8be9fd;font-style:italic"&gt;echo&lt;/span&gt; &lt;span style="color:#f1fa8c"&gt;&amp;#34;&lt;/span&gt;&lt;span style="color:#8be9fd;font-style:italic"&gt;$d&lt;/span&gt;&lt;span style="color:#f1fa8c"&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; docker compose pull &lt;span style="color:#6272a4"&gt;# pull new images&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; docker compose build --pull &lt;span style="color:#6272a4"&gt;# pull new base images and build new images&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; docker compose up -d --remove-orphans &lt;span style="color:#6272a4"&gt;# start new containers from new images&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#8be9fd;font-style:italic"&gt;cd&lt;/span&gt; ..
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#ff79c6"&gt;done&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id="3-docker-system-prune---force" class="paragraph-header"&gt;3. &lt;code&gt;docker system prune --force&lt;/code&gt; &lt;a
href="#3-docker-system-prune---force"&gt;&lt;/a&gt;&lt;/h4&gt;
&lt;p&gt;Free disk space by cleaning up old docker entities, mostly stopped containers and images.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p class="warning"&gt;&lt;code&gt;docker system prune --force&lt;/code&gt; might take some time. do not run container updates meanwhile as it could confuse docker (problems with port allocations)&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id="4-appsrestart_unhealthysh" class="paragraph-header"&gt;4. &lt;code&gt;/apps/restart_unhealthy.sh&lt;/code&gt; &lt;a
href="#4-appsrestart_unhealthysh"&gt;&lt;/a&gt;&lt;/h4&gt;
&lt;p&gt;Docker detects failing health checks but will happily ignore them. Docker Swarm (or Kubernetes) on the other hand will restart unhealthy containers. That missing feature can be corrected with an
&lt;a href="https://github.com/willfarrell/docker-autoheal" target="_blank" rel="noopener noreferrer"&gt;extra container&lt;/a&gt; or a really simple script:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#ff79c6"&gt;#!/bin/bash
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;docker ps --filter &lt;span style="color:#8be9fd;font-style:italic"&gt;health&lt;/span&gt;&lt;span style="color:#ff79c6"&gt;=&lt;/span&gt;unhealthy --format &lt;span style="color:#f1fa8c"&gt;&amp;#34;docker restart {{.ID}}&amp;#34;&lt;/span&gt; | bash
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="general-advice" class="paragraph-header"&gt;General advice &lt;a
href="#general-advice"&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Add a &lt;code&gt;mem_limit&lt;/code&gt; for every container, don&amp;rsquo;t forget it!&lt;/li&gt;
&lt;li&gt;If a container has no need to connect to the world (internet or local network) then make all attached Docker Networks &amp;ldquo;internal&amp;rdquo;.&lt;/li&gt;
&lt;li&gt;If addressing a container in the network via it&amp;rsquo;s name fails then set the &lt;code&gt;hostname&lt;/code&gt; explicitly.&lt;/li&gt;
&lt;li&gt;If volumes map to directories on the host (bind mounts) then create the folders before starting the containers. Otherwise docker will create the folders as user root which often causes permission problems.&lt;/li&gt;
&lt;/ul&gt;</description></item><item><title>Cleanup bloated postgres index</title><link>https://knrdl.github.io/posts/postgres-bloated-index/</link><pubDate>Sun, 10 Apr 2022 00:00:00 +0000</pubDate><guid>https://knrdl.github.io/posts/postgres-bloated-index/</guid><description>&lt;h2 id="1-find-db-byte-sizes" class="paragraph-header"&gt;1. find db byte sizes &lt;a
href="#1-find-db-byte-sizes"&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-sql" data-lang="sql"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#ff79c6"&gt;SELECT&lt;/span&gt; datname, pg_size_pretty(pg_database_size(datname))
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#ff79c6"&gt;FROM&lt;/span&gt; pg_database
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#ff79c6"&gt;ORDER&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;by&lt;/span&gt; pg_database_size(datname) &lt;span style="color:#ff79c6"&gt;DESC&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="2-find-tables--indices-sizes" class="paragraph-header"&gt;2. find tables + indices sizes &lt;a
href="#2-find-tables--indices-sizes"&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-sql" data-lang="sql"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#ff79c6"&gt;select&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;table_name&lt;/span&gt;, pg_size_pretty(pg_total_relation_size(quote_ident(&lt;span style="color:#ff79c6"&gt;table_name&lt;/span&gt;)))
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#ff79c6"&gt;from&lt;/span&gt; information_schema.tables
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#ff79c6"&gt;where&lt;/span&gt; table_schema &lt;span style="color:#ff79c6"&gt;=&lt;/span&gt; &lt;span style="color:#f1fa8c"&gt;&amp;#39;public&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#ff79c6"&gt;order&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;by&lt;/span&gt; pg_total_relation_size(quote_ident(&lt;span style="color:#ff79c6"&gt;table_name&lt;/span&gt;)) &lt;span style="color:#ff79c6"&gt;desc&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="3-recreate-index" class="paragraph-header"&gt;3. recreate index &lt;a
href="#3-recreate-index"&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-sql" data-lang="sql"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#ff79c6"&gt;REINDEX&lt;/span&gt; &lt;span style="color:#ff79c6"&gt;TABLE&lt;/span&gt; hungry;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="conclusion" class="paragraph-header"&gt;Conclusion &lt;a
href="#conclusion"&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;index shrank from ~12GiB to ~800MiB&lt;/p&gt;</description></item><item><title>Docker Swarm: `error creating vxlan interface: file exists`</title><link>https://knrdl.github.io/posts/docker-swarm-error-create-vxlan/</link><pubDate>Sun, 10 Apr 2022 00:00:00 +0000</pubDate><guid>https://knrdl.github.io/posts/docker-swarm-error-create-vxlan/</guid><description>&lt;p&gt;If docker swarm rejects to deploy a service because network interface already exists:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;$ docker service ps stackname_appname --no-trunc
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;Rejected &lt;span style="color:#bd93f9"&gt;34&lt;/span&gt; seconds ago &lt;span style="color:#f1fa8c"&gt;&amp;#34;network sandbox join failed: subnet sandbox join failed for &amp;#34;&lt;/span&gt;10.0.14.0/24&lt;span style="color:#f1fa8c"&gt;&amp;#34;: error creating vxlan interface: file exists
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Then find all problematic interfaces on the host and delete them:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;$ ip -d link show | grep vx | grep DOWN
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;$ sudo ip link delete vx-001095-owhr8 &lt;span style="color:#6272a4"&gt;# for each entry&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Now redeploying should work!&lt;/p&gt;</description></item><item><title>Fix gitlab immense disk usage</title><link>https://knrdl.github.io/posts/gitlab-immense-disk-usage/</link><pubDate>Mon, 28 Feb 2022 00:00:00 +0000</pubDate><guid>https://knrdl.github.io/posts/gitlab-immense-disk-usage/</guid><description>&lt;p&gt;The gitlab docker registry has no cleanup job per default. If an image tag gets overwritten (updated) then the original
image layer blobs will be kept as orphans. To clean those up run:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;gitlab-ctl registry-garbage-collect --delete-untagged --delete-manifest
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="automation" class="paragraph-header"&gt;Automation &lt;a
href="#automation"&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;run the command via Cron (the gitlab image contains &lt;code&gt;go-crond&lt;/code&gt;)&lt;/li&gt;
&lt;li&gt;set command in env var &lt;code&gt;GITLAB_POST_RECONFIGURE_SCRIPT&lt;/code&gt; (executed at least on each container start)&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="conclusion" class="paragraph-header"&gt;Conclusion &lt;a
href="#conclusion"&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;170GiB server disk storage freed&lt;/p&gt;</description></item></channel></rss>